<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemoTwin: Digital Twins for Chemotherapy Effects</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("zw5gaDMv_koqacN8M");
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #fafbfc;
            color: #1a1a1a;
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 200px;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            z-index: -2;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            display: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 102, 204, 0.2);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); }
            100% { transform: translateY(-100vh) translateX(100px); }
        }

        /* BLUETOOTH SIDEBAR */
        .bluetooth-sidebar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            z-index: 1000;
            width: 300px;
            display: none;
        }

        .bluetooth-sidebar.active {
            display: block;
        }

        .bluetooth-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(0, 102, 204, 0.1);
        }

        .bluetooth-icon {
            font-size: 24px;
            color: #0066cc;
        }

        .bluetooth-title {
            font-size: 1em;
            font-weight: 600;
            color: #0066cc;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #94a3b8;
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .device-status-text {
            font-size: 0.85em;
            color: #475569;
            font-weight: 500;
        }

        .vitals-display {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .vital-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .vital-item:last-child {
            border-bottom: none;
        }

        .vital-label {
            font-size: 0.8em;
            color: #64748b;
            font-weight: 500;
        }

        .vital-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #0066cc;
        }

        .btn-connect {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #0066cc, #3399ff);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.3);
        }

        .btn-disconnect {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            font-size: 2.5em;
            color: #1e293b;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            letter-spacing: -0.02em;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .subtitle {
            color: #64748b;
            font-size: 1.05em;
            text-align: center;
            margin-bottom: 24px;
            font-weight: 400;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .view-btn {
            padding: 12px 28px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
            background: white;
            color: #64748b;
        }

        .view-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
        }

        .view-btn:hover {
            border-color: #1e293b;
            color: #1e293b;
        }

        .view-btn.active:hover {
            background: #334155;
            border-color: #334155;
        }

        .patient-id-section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid #e5e7eb;
        }

        .patient-id-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .id-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Patient Profile Section - Matches Patient ID Section */
        .patient-profile-section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid #e5e7eb;
        }

        .patient-profile-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
            text-align: center;
        }

        .patient-profile-section h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .profile-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
        }

        #currentPatientId {
            color: #059669;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .patient-id-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .patient-id-input:focus {
            outline: none;
            border-color: #1e293b;
            box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .btn-primary {
            background: #1e293b;
            color: white;
        }

        .btn-primary:hover {
            background: #334155;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .btn-secondary {
            background: #7c3aed;
            color: white;
        }

        .btn-secondary:hover {
            background: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
            .bluetooth-sidebar {
                position: static;
                transform: none;
                margin-bottom: 20px;
                width: 100%;
            }
        }

        .input-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 28px;
            height: fit-content;
            display: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .input-panel.active {
            display: block;
        }

        .input-panel h2 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 600;
        }

        .form-section {
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid #f1f5f9;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            color: #1e293b;
            margin-bottom: 18px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #475569;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 11px 14px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            color: #1e293b;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #1e293b;
            background: white;
            box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
        }

        /* Horizontal Grid Layout for Demographics and Vitals */
        .horizontal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .horizontal-grid {
                grid-template-columns: 1fr;
            }
        }

        .dose-display {
            background: rgba(230, 240, 250, 0.5);
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .dose-display label {
            display: block;
            color: #0066cc;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .dose-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .dose-progress {
            width: 100%;
            height: 10px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .dose-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .dose-display small {
            color: #666;
            font-size: 0.85em;
        }

        .btn-add-session {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-session:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .session-count {
            margin-top: 15px;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
        }

        .session-count span {
            color: #10b981;
            font-weight: bold;
            font-size: 1.2em;
        }

        .results-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 28px;
            min-height: 600px;
            display: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .results-panel.active {
            display: block;
        }

        .results-panel h2 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.6em;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 102, 204, 0.2);
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-weight: 500;
            font-size: 0.95em;
        }

        .tab:hover {
            color: #0066cc;
        }

        .tab.active {
            color: #0066cc;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0066cc, #3399ff);
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Accordion Styles for Research Calculation Rules */
        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .accordion-item {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .accordion-item:hover {
            border-color: #0066cc;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transition: all 0.3s ease;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        }

        .accordion-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .accordion-icon.cardio { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
        .accordion-icon.neutro { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .accordion-icon.anemia { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); }
        .accordion-icon.info { background: linear-gradient(135deg, #e0f2fe 0%, #cffafe 100%); }

        .accordion-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.05em;
        }

        .accordion-subtitle {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 2px;
        }

        .accordion-arrow {
            font-size: 1.4em;
            color: #94a3b8;
            transition: transform 0.3s ease;
        }

        .accordion-item.active .accordion-arrow {
            transform: rotate(180deg);
            color: #0066cc;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            background: white;
        }

        .accordion-item.active .accordion-content {
            max-height: 2000px;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .accordion-body {
            color: #475569;
            line-height: 1.7;
        }

        .calc-step {
            background: #f8fafc;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #0066cc;
        }

        .calc-step strong {
            color: #1e293b;
        }

        .calc-result {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
        }

        .calc-result.high-risk {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
            color: #991b1b;
        }

        .calc-result.medium-risk {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .calc-result.low-risk {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        /* First Session Prompt Styles */
        .first-session-prompt {
            margin-top: 20px;
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 50%, #ede9fe 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #93c5fd;
        }

        .prompt-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .prompt-icon {
            font-size: 2em;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.15);
        }

        .prompt-text {
            flex: 1;
            min-width: 200px;
        }

        .prompt-text strong {
            display: block;
            color: #1e40af;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .prompt-text span {
            color: #3b82f6;
            font-size: 0.95em;
        }

        .prompt-btn {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        @keyframes pulse-highlight {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(0, 102, 204, 0.2);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 4px 20px rgba(0, 102, 204, 0.5);
            }
        }

        .alert {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert h4 {
            color: #991b1b;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .alert p {
            color: #7f1d1d;
            font-size: 0.95em;
            line-height: 1.6;
            margin: 5px 0;
        }

        .alert ul {
            margin: 10px 0 10px 20px;
            color: #7f1d1d;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s;
        }

        .metric-card:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .metric-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #1e293b;
            margin: 10px 0;
        }

        .metric-label {
            color: #64748b;
            font-size: 0.85em;
            margin-top: 8px;
            font-weight: 500;
        }

        .digital-twin-badge {
            display: inline-block;
            background: #1e293b;
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 10px;
            letter-spacing: 0.5px;
        }

        .study-card {
            background: white;
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .study-card:hover {
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.15);
            transform: translateX(5px);
        }

        .study-card h5 {
            color: #0066cc;
            margin-bottom: 10px;
            font-size: 1.05em;
            font-weight: 600;
        }

        .study-card p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.7;
            margin-bottom: 10px;
        }

        .study-card .relevance-tag {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 8px;
        }

        .study-card cite {
            color: #888;
            font-size: 0.85em;
            font-style: italic;
            display: block;
            margin-top: 8px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #0066cc;
            margin-bottom: 15px;
        }

        canvas {
            max-width: 100%;
            height: 300px !important;
        }

        .session-item {
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(230, 240, 250, 0.4);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .session-item:hover {
            background: rgba(230, 240, 250, 0.7);
            transform: translateX(5px);
        }

        .session-item h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }

        .session-item p {
            color: #555;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .no-data-message {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .recovery-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 20px;
            color: white;
            margin-bottom: 25px;
        }

        .recovery-circle {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .recovery-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: white;
        }

        .patient-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .patient-metric-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .patient-metric-card.heart {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .patient-metric-card.blood {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .patient-metric-card.energy {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
        }

        .patient-metric-card .metric-title {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .heart .metric-bar-fill {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .blood .metric-bar-fill {
            background: linear-gradient(90deg, #2563eb, #3b82f6);
        }

        .energy .metric-bar-fill {
            background: linear-gradient(90deg, #ca8a04, #eab308);
        }

        .patient-advice {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            line-height: 1.8;
        }

        .twin-analysis-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .twin-analysis-box h4 {
            color: #0369a1;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .twin-analysis-box p {
            color: #075985;
            line-height: 1.7;
            margin: 8px 0;
        }

        .twin-analysis-box ul {
            margin: 8px 0 8px 20px;
            color: #075985;
        }

        /* FOOTER SECTION */
        .footer {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 50px 20px 30px;
            margin-top: 60px;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 30px;
        }

        .footer-section h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .footer-section p {
            color: #cbd5e1;
            line-height: 1.8;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .footer-section a {
            color: #93c5fd;
            text-decoration: none;
            transition: all 0.3s;
            display: block;
            margin-bottom: 8px;
        }

        .footer-section a:hover {
            color: #60a5fa;
            transform: translateX(5px);
        }

        .contact-info {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 12px;
        }

        .contact-icon {
            color: #3b82f6;
            font-size: 1.2em;
            margin-top: 2px;
        }

        .footer-bottom {
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            padding-top: 25px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.9em;
        }

        .copyright {
            margin-bottom: 10px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #93c5fd;
            text-decoration: none;
            transition: all 0.3s;
        }

        .footer-links a:hover {
            color: #60a5fa;
        }

        /* NEW STYLES FOR MODIFICATIONS */
        .required-field::after {
            content: " *";
            color: #ef4444;
        }

        .dose-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .dose-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }

        .risk-detail-panel {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .risk-detail-panel.active {
            display: block;
        }

        .calculation-step {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #0066cc;
        }

        .simulation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .simulation-dose-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .simulation-results {
            background: #f0f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        /* Custom Dropdown Styling */
        .custom-select {
            position: relative;
            width: 100%;
        }

        .select-display {
            background: white;
            border: none;
            border-radius: 12px 12px 0 0;
            padding: 25px 30px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .select-display.active {
            border-radius: 12px 12px 0 0;
        }

        .arrow {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #666;
            transition: transform 0.3s ease;
        }

        .arrow.rotate {
            transform: rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 10;
        }

        .select-options.show {
            max-height: 400px;
            overflow-y: auto;
        }

        .option-item {
            padding: 25px 30px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-top: 1px solid #e0e0e0;
        }

        .option-item:hover {
            background-color: #f5f5f5;
        }

        .option-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .custom-select.show .select-display {
            border-radius: 12px 12px 0 0;
        }

        /* Close button for Bluetooth sidebar */
        .bluetooth-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .bluetooth-close-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        /* Cancer subtype styling */
        .cancer-subtype-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .cancer-subtype-section h4 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .subtype-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .subtype-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtype-option input {
            margin: 0;
        }

        .subtype-option label {
            margin: 0;
            font-weight: 500;
            color: #475569;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>
    
    <!-- BLUETOOTH SIDEBAR -->
    <div class="bluetooth-sidebar" id="bluetoothSidebar">
        <button class="bluetooth-close-btn" onclick="closeBluetooth()" title="Close">✕</button>
        <div class="bluetooth-header">
            <div class="bluetooth-icon" style="width: 24px; height: 24px; background: #0066cc; border-radius: 50%;"></div>
            <div class="bluetooth-title">Device Monitor</div>
        </div>
        
        <div class="device-status">
            <div class="status-dot" id="deviceStatusDot"></div>
            <div class="device-status-text" id="deviceStatusText">No device connected</div>
        </div>
        
        <div class="vitals-display" id="vitalsDisplay" style="display:none;">
            <div class="vital-item">
                <span class="vital-label">Heart Rate</span>
                <span class="vital-value" id="sidebarHR">-- bpm</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Blood Pressure</span>
                <span class="vital-value" id="sidebarBP">--/--</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Temperature</span>
                <span class="vital-value" id="sidebarTemp">-- °C</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Ejection Fraction</span>
                <span class="vital-value" id="sidebarEF">-- %</span>
            </div>
            <div class="vital-item" style="border-top: 2px solid #f59e0b; padding-top: 10px; margin-top: 5px;">
                <span class="vital-label" style="color: #92400e; font-weight: 600;">GLS (Current)</span>
                <span class="vital-value" id="sidebarGLS" style="color: #dc2626;">-- %</span>
            </div>
            <div class="vital-item">
                <span class="vital-label" style="color: #92400e;">GLS Change</span>
                <span class="vital-value" id="sidebarGLSChange" style="font-size: 0.9em;">-- %</span>
            </div>
        </div>
        
        <button class="btn-connect" id="connectBtn" onclick="connectBluetoothDevice()">
            Connect Device
        </button>
    </div>
    
    <div class="main-container">
        <header class="header">
            <h1>ChemoTwin Clinical Platform</h1>
            <p class="subtitle">Evidence-Based Digital Twins for Chemotherapy Effects with Research-Powered Insights</p>
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('doctor')">Clinical Dashboard</button>
                <button class="view-btn" onclick="switchView('patient')">Patient View</button>
            </div>
        </header>
        
        <div class="patient-id-section">
            <h2>Patient Identification & Management</h2>
            <div class="id-controls">
                <input type="text" id="patientId" placeholder="Enter Patient ID (e.g., PT-2025-001)" class="patient-id-input">
                <button onclick="generateNewPatient()" class="btn btn-success">Generate New Patient</button>
                <button onclick="exportPatientReport()" class="btn btn-secondary" id="exportBtn" style="display:none;">Export Report</button>
            </div>
        </div>

        <div class="patient-profile-section" id="patientProfileSection" style="display:none;">
            <h2>Patient Profile - <span id="currentPatientId">No Patient Loaded</span></h2>

            <div class="profile-content">
                <div class="profile-column">
                    <h3>Demographics</h3>
                    <div class="horizontal-grid">
                        <div class="input-group">
                            <label class="required-field">Age (years)</label>
                            <input type="number" id="age" min="1" max="100" value="45" oninput="updatePatientRealtime()">
                        </div>

                        <div class="input-group">
                            <label class="required-field">Sex</label>
                            <select id="sex" onchange="updatePatientRealtime()">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label class="required-field">Cancer Type</label>
                            <select id="cancer" onchange="toggleCancerSubtypes()">
                                <option value="leukemia">Leukemia</option>
                                <option value="lymphoma">Lymphoma</option>
                            </select>
                        </div>
                    </div>

                    <div class="cancer-subtype-section" id="cancerSubtypeSection" style="display: none;">
                        <h4>Cancer Subtype</h4>
                        <div class="subtype-options" id="leukemiaSubtypes">
                            <div class="subtype-option">
                                <input type="radio" id="leukemia_all" name="cancerSubtype" value="ALL">
                                <label for="leukemia_all">Acute Lymphoblastic Leukemia (ALL)</label>
                            </div>
                            <div class="subtype-option">
                                <input type="radio" id="leukemia_aml" name="cancerSubtype" value="AML">
                                <label for="leukemia_aml">Acute Myeloid Leukemia (AML)</label>
                            </div>
                            <div class="subtype-option">
                                <input type="radio" id="leukemia_cll" name="cancerSubtype" value="CLL">
                                <label for="leukemia_cll">Chronic Lymphocytic Leukemia (CLL)</label>
                            </div>
                            <div class="subtype-option">
                                <input type="radio" id="leukemia_cml" name="cancerSubtype" value="CML">
                                <label for="leukemia_cml">Chronic Myeloid Leukemia (CML)</label>
                            </div>
                            <div class="subtype-option">
                                <input type="radio" id="leukemia_other" name="cancerSubtype" value="Other Leukemia">
                                <label for="leukemia_other">Other Leukemia</label>
                            </div>
                        </div>
                        <div class="subtype-options" id="lymphomaSubtypes" style="display: none;">
                            <div class="subtype-option">
                                <input type="radio" id="lymphoma_hl" name="cancerSubtype" value="HL">
                                <label for="lymphoma_hl">Hodgkin Lymphoma (HL)</label>
                            </div>
                            <div class="subtype-option">
                                <input type="radio" id="lymphoma_nhl" name="cancerSubtype" value="NHL">
                                <label for="lymphoma_nhl">Non-Hodgkin Lymphoma (NHL)</label>
                            </div>
                            <div class="subtype-option">
                                <input type="radio" id="lymphoma_other" name="cancerSubtype" value="Other Lymphoma">
                                <label for="lymphoma_other">Other Lymphoma</label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="required-field">Chronic Diseases</label>
                        <select id="chronicDiseases" multiple size="6" onchange="updatePatientRealtime()">
                            <option value="none">None</option>
                            <option value="diabetes">Diabetes</option>
                            <option value="hypertension">Hypertension</option>
                            <option value="heart_disease">Heart Disease</option>
                            <option value="kidney_disease">Kidney Disease</option>
                            <option value="liver_disease">Liver Disease</option>
                            <option value="copd">COPD (chronic lung disease)</option>
                            <option value="asthma">Asthma</option>
                            <option value="obesity">Obesity (BMI > 30)</option>
                            <option value="anemia">Anemia</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>

                <div class="profile-column">
                    <h3>Current Vitals</h3>
                    <div class="horizontal-grid">
                        <div class="input-group">
                            <label>Temperature (°C)</label>
                            <input type="number" id="temperature" step="0.1" min="35" max="42" value="37.0" oninput="updatePatientRealtime()">
                        </div>

                        <div class="input-group">
                            <label>Blood Pressure (mmHg)</label>
                            <input type="text" id="bloodPressure" placeholder="120/80" value="120/80" oninput="updatePatientRealtime()">
                        </div>

                        <div class="input-group">
                            <label>Heart Rate (bpm)</label>
                            <input type="number" id="heartRate" min="40" max="200" value="75" oninput="updatePatientRealtime()">
                        </div>

                        <div class="input-group">
                            <label>Ejection Fraction (%)</label>
                            <input type="number" id="ejectionFraction" min="20" max="80" value="60" oninput="updatePatientRealtime()">
                        </div>
                    </div>
                    
                    <!-- Global Longitudinal Strain (GLS) Section -->
                    <div class="gls-section" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 15px; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.3em;"></span> Global Longitudinal Strain (GLS)
                            <span style="font-size: 0.7em; background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px; font-weight: 600;">MORE ACCURATE</span>
                        </h4>
                        <p style="color: #78350f; font-size: 0.85em; margin-bottom: 15px; line-height: 1.5;">
                            GLS detects cardiotoxicity <strong>2-3 months earlier</strong> than Ejection Fraction. Normal values: -20% to -22% (more negative = better function)
                        </p>
                        <div class="horizontal-grid">
                            <div class="input-group">
                                <label style="color: #92400e; font-weight: 600;">Baseline GLS (%)</label>
                                <input type="number" id="baselineGLS" step="0.1" min="-30" max="-10" value="-21.0" 
                                       oninput="updatePatientRealtime()" 
                                       style="background: white; border-color: #f59e0b;">
                                <small style="color: #92400e; font-size: 0.75em;">Pre-treatment value (typically -20% to -22%)</small>
                            </div>
                            <div class="input-group">
                                <label style="color: #92400e; font-weight: 600;">Current GLS (%)</label>
                                <input type="number" id="currentGLS" step="0.1" min="-30" max="-5" value="-21.0" 
                                       oninput="updatePatientRealtime()" 
                                       style="background: white; border-color: #f59e0b;">
                                <small style="color: #92400e; font-size: 0.75em;">Latest measurement (less negative = worse)</small>
                            </div>
                        </div>
                        <div id="glsChangeIndicator" style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px; display: none;">
                            <!-- GLS change will be displayed here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="first-session-prompt" id="firstSessionPrompt">
                <div class="prompt-content">
                    <div class="prompt-text">
                        <strong>Ready to start treatment?</strong>
                        <span>Add your first chemotherapy session</span>
                    </div>
                    <button onclick="scrollToAddSession()" class="prompt-btn">
                        Start First Session
                    </button>
                </div>
            </div>
        </div>

        <div class="dashboard" id="dashboardSection" style="display:none;">
            <div class="input-panel" id="patientForm">
                <h2>Treatment Management</h2>

                <div class="form-section">
                    <h3>Dosage & Sessions</h3>
                    <div class="dose-display">
                        <label>Cumulative Dose</label>
                        <div class="dose-value" id="cumulativeDoseDisplay">0 mg/m²</div>
                        <div class="dose-progress">
                            <div class="dose-progress-bar" id="doseProgressBar" style="width: 0%"></div>
                        </div>
                        <small>Maximum recommended: 550 mg/m²</small>
                    </div>
                    
                    <div class="dose-input-group">
                        <input type="number" id="sessionDose" class="dose-input" placeholder="Enter dose in mg/m²" value="60" min="1" max="100">
                        <button class="btn-add-session" onclick="addTreatmentSession()">
                            Add Treatment Session
                        </button>
                    </div>
                </div>
                
                <div class="session-count">
                    <strong>Total Sessions:</strong> <span id="sessionCount">0</span>
                </div>
            </div>
            
            <div class="results-panel" id="resultsArea">
                <h2>Analysis Results <span class="digital-twin-badge">Digital Twin Active</span></h2>
                
                <div id="doctorView">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('overview')">Overview</button>
                        <button class="tab" onclick="switchTab('risks')">Risks</button>
                        <button class="tab" onclick="switchTab('research-calculations')">Research Calculation Rules</button>
                        <button class="tab" onclick="switchTab('history')">Patient History</button>
                        <button class="tab" onclick="openVirtualSimulator()">Virtual Simulator</button>
                    </div>
                    
                    <div id="overview" class="tab-content active">
                        <div id="digitalTwinAnalysis"></div>
                        <div id="clinicalAlerts"></div>
                        <!-- Hidden elements for JavaScript compatibility -->
                        <div style="display:none;">
                            <span id="cardioRisk">--</span>
                            <span id="neutroRisk">--</span>
                            <span id="anemiaRisk">--</span>
                            <span id="qualityScore">--</span>
                        </div>
                    </div>
                    
                    <div id="risks" class="tab-content">
                        <h3>Risk Analysis <span class="digital-twin-badge">Patient-Specific</span></h3>
                        <p style="color: #666; margin-bottom: 20px;">Visual representation of calculated risks based on patient profile</p>
                        <div class="chart-container">
                            <h4>Personalized Risk Distribution</h4>
                            <canvas id="riskChart"></canvas>
                            <div id="riskDetailPanel" class="risk-detail-panel"></div>
                        </div>
                    </div>
                    
                    <div id="research-calculations" class="tab-content">
                        <h3>Calculations</h3>
                        <p style="color: #666; margin-bottom: 20px;">Click on any section to see detailed calculations</p>
                        <div id="researchCalculationsContainer"></div>
                    </div>
                    
                    <div id="history" class="tab-content">
                        <h3>Treatment History & Progress</h3>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div id="sessionHistoryList"></div>
                    </div>
                </div>
                
                <div id="patientView" style="display: none;">
                    <div id="noDataMessage" class="no-data-message">
                        <div class="icon"></div>
                        <p>Add your first treatment session to see your personalized health journey</p>
                    </div>
                    
                    <div id="patientDataContent" style="display: none;">
                        <div class="recovery-section">
                            <h3>Your Recovery Score</h3>
                            <div class="recovery-circle">
                                <svg width="200" height="200" id="recoveryCircleSVG"></svg>
                                <div class="recovery-number" id="recoveryScoreNumber">--</div>
                            </div>
                            <p class="recovery-message" id="recoveryMessage"></p>
                        </div>
                        
                        <div class="patient-metrics-grid">
                            <div class="patient-metric-card heart">
                                <div class="metric-icon"></div>
                                <div class="metric-title">Heart Health</div>
                                <div class="metric-value" id="patientHeartScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="heartBar"></div>
                                </div>
                            </div>
                            
                            <div class="patient-metric-card blood">
                                <div class="metric-icon"></div>
                                <div class="metric-title">Blood Health</div>
                                <div class="metric-value" id="patientBloodScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="bloodBar"></div>
                                </div>
                            </div>
                            
                            <div class="patient-metric-card energy">
                                <div class="metric-icon"></div>
                                <div class="metric-title">Energy Level</div>
                                <div class="metric-value" id="patientEnergyScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="energyBar"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>Your Health Journey</h3>
                            <canvas id="patientJourneyChart"></canvas>
                        </div>
                        
                        <div class="patient-advice" id="patientAdviceSection"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FOOTER -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About ChemoTwin</h3>
                <p>ChemoTwin is an advanced digital twin platform leveraging artificial intelligence and evidence-based research to personalize chemotherapy treatment planning and monitoring.</p>
                <p style="margin-top: 15px;">Developed as part of cutting-edge research in precision oncology and computational medicine.</p>
            </div>
            
            <div class="footer-section">
                <h3>Contact Information</h3>
                <div class="contact-info">
                    <span class="contact-icon"></span>
                    <div>
                        <p><strong>Bakr Waheed</strong></p>
                        <p>Developer & Researcher</p>
                    </div>
                </div>
                <div class="contact-info">
                    <span class="contact-icon"></span>
                    <div>
                        <a href="mailto:bakrwaheed0@gmail.com">bakrwaheed0@gmail.com</a>
                        <a href="mailto:bakr.salheen@student.giu-uni.de">bakr.salheen@student.giu-uni.de</a>
                    </div>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Resources</h3>
                <a href="https://github.com/Bakrwa7eed/ChemoTwin/blob/main/documentation.pdf" target="_blank">Documentation</a>
                <a href="https://github.com/Bakrwa7eed/ChemoTwin" target="_blank">GitHub Repository</a>
                <a href="https://www.linkedin.com/in/bakr-waheed-1a127a30a/" target="_blank">LinkedIn Profile</a>
                <a href="#" onclick="alert('Research papers available upon request'); return false;">Research Papers</a>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <a href="#" onclick="alert('Privacy Policy: This platform uses secure storage for patient data. All information is encrypted and stored locally.'); return false;">Privacy Policy</a>
                <a href="#" onclick="alert('Terms of Service: This is a research platform. Always consult with qualified healthcare professionals for medical decisions.'); return false;">Terms of Service</a>
                <a href="#" onclick="alert('Medical Disclaimer: This platform is for research and educational purposes. Not intended to replace professional medical advice.'); return false;">Medical Disclaimer</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="copyright">
                © 2025 ChemoTwin Platform. All rights reserved. | Developed by <strong>Bakr Waheed</strong>
            </div>
            <div class="footer-links">
                <a href="https://github.com/Bakrwa7eed/ChemoTwin" target="_blank">GitHub</a>
                <span style="color: #475569;">•</span>
                <a href="https://www.linkedin.com/in/bakr-waheed-1a127a30a/" target="_blank">LinkedIn</a>
                <span style="color: #475569;">•</span>
                <a href="mailto:bakrwaheed0@gmail.com">Contact</a>
            </div>
            <p style="margin-top: 15px; font-size: 0.85em; color: #64748b;">
                Medical AI Research Platform | Version 2.0 | Last Updated: January 2025
            </p>
        </div>
    </footer>
    
    <script>
        // Global state
        let currentPatient = null;
        let currentView = 'doctor';
        let charts = {};
        let bluetoothDevice = null;
        let heartRateCharacteristic = null;
        let selectedRiskType = null;

        // Close Bluetooth sidebar
        function closeBluetooth() {
            document.getElementById('bluetoothSidebar').classList.remove('active');
        }

        // Toggle cancer subtype selection
        function toggleCancerSubtypes() {
            const cancerType = document.getElementById('cancer').value;
            const subtypeSection = document.getElementById('cancerSubtypeSection');
            const leukemiaSubtypes = document.getElementById('leukemiaSubtypes');
            const lymphomaSubtypes = document.getElementById('lymphomaSubtypes');
            
            if (cancerType === 'leukemia' || cancerType === 'lymphoma') {
                subtypeSection.style.display = 'block';
                
                if (cancerType === 'leukemia') {
                    leukemiaSubtypes.style.display = 'grid';
                    lymphomaSubtypes.style.display = 'none';
                } else {
                    leukemiaSubtypes.style.display = 'none';
                    lymphomaSubtypes.style.display = 'grid';
                }
            } else {
                subtypeSection.style.display = 'none';
            }
            
            updatePatientRealtime();
        }

        // Open Virtual Simulator in new window
        function openVirtualSimulator() {
            if (currentPatient) {
                // Pass patient data to simulator
                localStorage.setItem('simulatorPatientData', JSON.stringify(currentPatient));
                window.open('virtual-simulator.html', 'VirtualSimulator', 'width=1400,height=900');
            } else {
                alert('Please load or create a patient first');
            }
        }

        // Email notification function
        async function sendEmailNotification(data) {
            console.log('📧 Attempting to send email notification for patient:', data.patientId);

            // Validate EmailJS is loaded
            if (typeof emailjs === 'undefined') {
                console.error('EmailJS library not loaded! Check your internet connection.');
                return;
            }

            const emailBody = `
NEW PATIENT ENTRY NOTIFICATION

Patient ID: ${data.patientId}
Entry Time: ${new Date(data.timestamp).toLocaleString()}

Demographics:
- Age: ${data.age} years
- Sex: ${data.sex}
- Cancer Type: ${data.cancer}
- Cancer Subtype: ${data.cancerSubtype || 'Not specified'}
- Chronic Diseases: ${data.chronicDiseases.join(', ') || 'None'}

Current Vitals:
- Temperature: ${data.vitals.temperature}°C
- Blood Pressure: ${data.vitals.bloodPressure}
- Heart Rate: ${data.vitals.heartRate} bpm
- Ejection Fraction: ${data.ejectionFraction || 'N/A'}%

Treatment Status:
- Total Sessions: ${data.sessions.length}
- Cumulative Dose: ${data.cumulativeDose} mg/m²

${data.sessions.length > 0 ? `
Latest Risk Profile:
- Cardiotoxicity Risk: ${data.latestRisks.cardioRisk}%
- Neutropenia Risk: ${data.latestRisks.neutroRisk}%
- Recovery Score: ${data.latestRisks.overallScore}
` : ''}

---
This is an automated notification from ChemoTwin Platform.
    `;

            // Send email using EmailJS
            const emailParams = {
                visitor_id: data.patientId,
                timestamp: new Date(data.timestamp).toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                user_agent: `Patient Entry - Age: ${data.age}, Sex: ${data.sex}, Cancer: ${data.cancer}, Subtype: ${data.cancerSubtype || 'Not specified'}`,
                screen_resolution: `Sessions: ${data.sessions.length} | Dose: ${data.cumulativeDose} mg/m²`,
                language: `Chronic Diseases: ${data.chronicDiseases.join(', ') || 'None'}`
            };

            console.log('📨 Email parameters prepared:', emailParams);

            try {
                console.log('⏳ Sending email via EmailJS...');
                const response = await emailjs.send('service_e8dcl0l', 'template_pxtj7kr', emailParams);
                console.log('Email sent successfully! Status:', response.status, 'Response:', response);
            } catch (error) {
                console.error('Failed to send patient email!');
                console.error('Error details:', error);
                console.error('Error message:', error.text || error.message);
                console.error('Error status:', error.status);

                // Provide helpful debugging info
                if (error.status === 400) {
                    console.error('💡 Bad Request - Check your EmailJS template parameters match the ones being sent');
                } else if (error.status === 401 || error.status === 403) {
                    console.error('💡 Unauthorized - Check your EmailJS public key and service/template IDs');
                } else if (error.status === 422) {
                    console.error('💡 Invalid parameters - Verify template variable names in EmailJS dashboard');
                }
            }
        }

        // Track visitor on page load
        async function trackVisitor() {
            console.log('👤 Tracking visitor access...');

            // Validate EmailJS is loaded
            if (typeof emailjs === 'undefined') {
                console.error('EmailJS library not loaded for visitor tracking! Check your internet connection.');
                return;
            }

            const visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const timestamp = new Date().toISOString();

            const visitorData = {
                id: visitorId,
                timestamp: timestamp,
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                language: navigator.language
            };

            // Send real email using EmailJS
            const emailParams = {
                visitor_id: visitorId,
                timestamp: new Date(timestamp).toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                user_agent: navigator.userAgent,
                screen_resolution: `${window.screen.width}x${window.screen.height}`,
                language: navigator.language
            };

            console.log('📨 Visitor tracking email parameters:', emailParams);

            try {
                console.log('⏳ Sending visitor tracking email...');
                const response = await emailjs.send('service_e8dcl0l', 'template_pxtj7kr', emailParams);
                console.log('Visitor tracking email sent successfully!', response.status, response.text);
            } catch (error) {
                console.error('Failed to send visitor email!');
                console.error('Error details:', error);
                console.error('Error message:', error.text || error.message);
                console.error('Error status:', error.status);
            }
        }
        
        // ============================================================================
        // GLOBAL LONGITUDINAL STRAIN (GLS) CALCULATION FUNCTIONS
        // Based on ASE/EACVI Expert Consensus on Cardio-Oncology Guidelines
        // ============================================================================
        
        /**
         * Calculate GLS Relative Change (%)
         * Formula: ((Current GLS - Baseline GLS) / |Baseline GLS|) × 100
         * 
         * IMPORTANT: GLS values are negative (e.g., -21%). A less negative value 
         * (e.g., -18%) indicates worse function. A POSITIVE relative change 
         * indicates worsening (cardiotoxicity risk).
         * 
         * Example: Baseline = -21%, Current = -18%
         * Change = ((-18) - (-21)) / |-21| × 100 = (3 / 21) × 100 = +14.3%
         * This +14.3% change indicates cardiac function is deteriorating.
         */
        function calculateGLSRelativeChange(baselineGLS, currentGLS) {
            // Ensure values are negative (GLS convention)
            const baseline = Math.abs(baselineGLS) > 0 ? baselineGLS : -21.0;
            const current = currentGLS;
            
            // Calculate relative change: positive value = worsening
            // Formula: ((current - baseline) / |baseline|) × 100
            const relativeChange = ((current - baseline) / Math.abs(baseline)) * 100;
            
            return relativeChange;
        }
        
        /**
         * Assess GLS Status based on Absolute Value
         * Per ASE/EACVI Guidelines:
         * - Normal: GLS ≤ -20% (more negative)
         * - Borderline: -18% to -19.9%
         * - Abnormal: -16% to -17.9%
         * - Severely Abnormal: > -15% (less negative, e.g., -14%, -12%)
         */
        function assessAbsoluteGLSStatus(currentGLS) {
            const absGLS = currentGLS; // Already negative
            
            if (absGLS <= -20) {
                return { status: 'normal', label: 'Normal', color: '#10b981', riskAddition: 0 };
            } else if (absGLS <= -18) {
                return { status: 'borderline', label: 'Borderline', color: '#f59e0b', riskAddition: 5 };
            } else if (absGLS <= -16) {
                return { status: 'abnormal', label: 'Abnormal', color: '#ef4444', riskAddition: 15 };
            } else {
                return { status: 'severe', label: 'Severely Abnormal', color: '#dc2626', riskAddition: 30 };
            }
        }
        
        /**
         * Assess GLS Change Significance
         * Per ASE/EACVI Expert Consensus:
         * - ≥15% relative decrease from baseline = SIGNIFICANT CARDIOTOXICITY
         * - 10-14.9% change = WARNING - Close monitoring required
         * - <10% change = Within acceptable limits
         */
        function assessGLSChangeSignificance(relativeChange) {
            if (relativeChange >= 15) {
                return {
                    status: 'significant',
                    label: 'SIGNIFICANT CARDIOTOXICITY DETECTED',
                    description: '≥15% GLS reduction from baseline indicates subclinical LV dysfunction',
                    color: '#dc2626',
                    riskAddition: 25,
                    recommendation: 'URGENT: Consider cardiology consultation, dose modification, or cardioprotective therapy'
                };
            } else if (relativeChange >= 10) {
                return {
                    status: 'warning',
                    label: 'WARNING - Cardiac Function Declining',
                    description: '10-15% GLS reduction indicates early cardiac strain',
                    color: '#f59e0b',
                    riskAddition: 12,
                    recommendation: 'Increase monitoring frequency, consider prophylactic measures'
                };
            } else if (relativeChange >= 5) {
                return {
                    status: 'mild',
                    label: 'Mild Change',
                    description: 'Minor GLS change within acceptable range',
                    color: '#3b82f6',
                    riskAddition: 5,
                    recommendation: 'Continue standard monitoring protocol'
                };
            } else {
                return {
                    status: 'normal',
                    label: 'Stable',
                    description: 'GLS within normal variation',
                    color: '#10b981',
                    riskAddition: 0,
                    recommendation: 'Continue current treatment plan'
                };
            }
        }
        
        /**
         * Calculate Comprehensive GLS-based Cardiotoxicity Risk
         * Combines absolute GLS status and relative change from baseline
         * This is the PRIMARY cardiotoxicity detection method (more accurate than LVEF alone)
         */
        function calculateGLSCardiotoxicityRisk(baselineGLS, currentGLS) {
            const relativeChange = calculateGLSRelativeChange(baselineGLS, currentGLS);
            const absoluteStatus = assessAbsoluteGLSStatus(currentGLS);
            const changeSignificance = assessGLSChangeSignificance(relativeChange);
            
            // Combined risk assessment
            let glsRiskScore = 0;
            let glsModifiers = [];
            
            // Add risk from absolute GLS value
            glsRiskScore += absoluteStatus.riskAddition;
            if (absoluteStatus.riskAddition > 0) {
                glsModifiers.push(`Absolute GLS (${currentGLS.toFixed(1)}%) is ${absoluteStatus.label.toLowerCase()} - adds +${absoluteStatus.riskAddition}% risk`);
            }
            
            // Add risk from relative change (this is the key indicator per guidelines)
            glsRiskScore += changeSignificance.riskAddition;
            if (changeSignificance.riskAddition > 0) {
                glsModifiers.push(`GLS relative change of ${relativeChange >= 0 ? '+' : ''}${relativeChange.toFixed(1)}% from baseline - adds +${changeSignificance.riskAddition}% risk`);
            }
            
            return {
                baselineGLS,
                currentGLS,
                relativeChange,
                absoluteStatus,
                changeSignificance,
                glsRiskScore,
                glsModifiers,
                isSignificantCardiotoxicity: relativeChange >= 15 || currentGLS > -16
            };
        }
        
        // ============================================================================
        // ENHANCED DIGITAL TWIN RISK CALCULATOR WITH GLS & CANCER SUBTYPES
        // ============================================================================
        function calculateDigitalTwinRisks(patient) {
            const { age, sex, cumulativeDose, chronicDiseases, vitals, cancer, cancerSubtype, ejectionFraction, baselineGLS, currentGLS } = patient;
            const dose = cumulativeDose;
            
            // Cardiotoxicity calculation with ejection fraction
            let cardioBase = 0;
            if (dose > 550) cardioBase = 36;
            else if (dose > 450) cardioBase = 24;
            else if (dose > 300) cardioBase = 12;
            else if (dose > 200) cardioBase = 5;
            else cardioBase = 1;
            
            let cardioModifiers = [];
            
            if (age < 18) {
                cardioBase += 8;
                cardioModifiers.push(`Pediatric age (${age}yo) adds +8% risk`);
            } else if (age > 65) {
                cardioBase += 10;
                cardioModifiers.push(`Advanced age (${age}yo) adds +10% risk`);
            }
            
            if (sex === 'female') {
                cardioBase += 4;
                cardioModifiers.push("Female sex adds +4% risk");
            }
            
            // Ejection fraction impact
            if (ejectionFraction < 50) {
                cardioBase += 15;
                cardioModifiers.push(`Low ejection fraction (${ejectionFraction}%) adds +15% risk`);
            } else if (ejectionFraction < 55) {
                cardioBase += 5;
                cardioModifiers.push(`Borderline ejection fraction (${ejectionFraction}%) adds +5% risk`);
            }
            
            // Cancer subtype-specific risks
            if (cancer === 'leukemia') {
                if (cancerSubtype === 'AML') {
                    cardioBase += 6;
                    cardioModifiers.push("AML subtype adds +6% cardiotoxicity risk");
                } else if (cancerSubtype === 'CML') {
                    cardioBase += 4;
                    cardioModifiers.push("CML subtype adds +4% cardiotoxicity risk");
                }
            } else if (cancer === 'lymphoma') {
                if (cancerSubtype === 'HL') {
                    cardioBase += 5;
                    cardioModifiers.push("Hodgkin Lymphoma adds +5% cardiotoxicity risk");
                }
            }
            
            // Chronic diseases
            if (chronicDiseases.includes('diabetes')) {
                cardioBase += 12;
                cardioModifiers.push("Diabetes adds +12% risk (damages blood vessels)");
            }
            if (chronicDiseases.includes('hypertension')) {
                cardioBase += 10;
                cardioModifiers.push("Hypertension adds +10% risk (strains heart)");
            }
            if (chronicDiseases.includes('heart_disease')) {
                cardioBase += 15;
                cardioModifiers.push("Pre-existing heart disease adds +15% risk");
            }
            if (chronicDiseases.includes('kidney_disease')) {
                cardioBase += 8;
                cardioModifiers.push("Kidney disease adds +8% risk (fluid retention)");
            }
            if (chronicDiseases.includes('obesity')) {
                cardioBase += 7;
                cardioModifiers.push("Obesity adds +7% risk (cardiac strain)");
            }
            
            // Vital signs
            const systolic = parseInt(vitals.bloodPressure.split('/')[0]);
            if (systolic > 140) {
                cardioBase += 6;
                cardioModifiers.push(`Elevated BP (${systolic} mmHg) adds +6% risk`);
            }
            
            if (vitals.heartRate > 100) {
                cardioBase += 5;
                cardioModifiers.push(`Tachycardia (${vitals.heartRate} bpm) adds +5% risk`);
            }
            
            // ============================================================================
            // GLS-BASED CARDIOTOXICITY ASSESSMENT (PRIMARY DETECTION METHOD)
            // Per ASE/EACVI Expert Consensus - More accurate than LVEF alone
            // ============================================================================
            const patientBaselineGLS = baselineGLS || -21.0;
            const patientCurrentGLS = currentGLS || -21.0;
            const glsAssessment = calculateGLSCardiotoxicityRisk(patientBaselineGLS, patientCurrentGLS);
            
            // Add GLS-based risk to cardiotoxicity calculation
            cardioBase += glsAssessment.glsRiskScore;
            
            // Add GLS modifiers to the explanation
            glsAssessment.glsModifiers.forEach(mod => {
                cardioModifiers.push(` GLS: ${mod}`);
            });
            
            // Add absolute GLS status message
            if (glsAssessment.absoluteStatus.status !== 'normal') {
                cardioModifiers.push(` Current GLS Status: ${glsAssessment.absoluteStatus.label} (${patientCurrentGLS.toFixed(1)}%)`);
            }
            
            // Add change significance message if concerning
            if (glsAssessment.changeSignificance.status !== 'normal') {
                cardioModifiers.push(` GLS Assessment: ${glsAssessment.changeSignificance.label}`);
            }
            
            const cardioRisk = Math.min(95, Math.round(cardioBase));
            
            // Neutropenia calculation with cancer subtype considerations
            let neutroBase = 35 + (dose / 600 * 45);
            let neutroModifiers = [];

            if (age > 65) {
                neutroBase += 12;
                neutroModifiers.push(`Age ${age} adds +12% (elderly immune system)`);
            }
            
            // Cancer subtype-specific neutropenia risks
            if (cancer === 'leukemia') {
                neutroBase += 18;
                neutroModifiers.push("Leukemia adds +18% (blood cancer affects WBC production)");
                
                if (cancerSubtype === 'ALL') {
                    neutroBase += 8;
                    neutroModifiers.push("ALL subtype adds +8% neutropenia risk");
                } else if (cancerSubtype === 'AML') {
                    neutroBase += 12;
                    neutroModifiers.push("AML subtype adds +12% neutropenia risk");
                }
            } else if (cancer === 'lymphoma') {
                neutroBase += 10;
                neutroModifiers.push("Lymphoma adds +10% neutropenia risk");
                
                if (cancerSubtype === 'NHL') {
                    neutroBase += 6;
                    neutroModifiers.push("NHL subtype adds +6% neutropenia risk");
                }
            }
            
            if (chronicDiseases.includes('diabetes')) {
                neutroBase += 8;
                neutroModifiers.push("Diabetes adds +8% (impaired immune function)");
            }
            if (chronicDiseases.includes('kidney_disease')) {
                neutroBase += 10;
                neutroModifiers.push("Kidney disease adds +10% (reduced drug clearance)");
            }
            if (chronicDiseases.includes('liver_disease')) {
                neutroBase += 9;
                neutroModifiers.push("Liver disease adds +9% (impaired drug metabolism)");
            }
            
            const neutroRisk = Math.min(95, Math.round(neutroBase));
            
            // Anemia calculation with pre-existing condition and cancer subtype
            let anemiaBase = 30 + (dose / 600 * 45);
            if (sex === 'female') anemiaBase += 8;
            
            // Cancer subtype-specific anemia risks
            if (cancer === 'leukemia') {
                anemiaBase += 15;
                if (cancerSubtype === 'AML') {
                    anemiaBase += 8;
                }
            }
            
            // Pre-existing anemia significantly increases risk
            if (chronicDiseases.includes('anemia')) {
                anemiaBase += 25;
            }
            
            const anemiaRisk = Math.min(90, Math.round(anemiaBase));
            
            // Other side effects
            let nauseaBase = 82;
            if (sex === 'female') nauseaBase += 10;
            const nauseaRisk = Math.min(98, Math.round(nauseaBase));
            
            let fatigueBase = 55 + (dose / 600 * 35);
            if (age > 60) fatigueBase += 10;
            const fatigueRisk = Math.min(95, Math.round(fatigueBase));
            
            let mucositisBase = 25 + (dose / 600 * 35);
            const mucositisRisk = Math.min(85, Math.round(mucositisBase));
            
            const overallScore = Math.round(100 - ((cardioRisk + neutroRisk + fatigueRisk) / 3) * 0.8);
            
            return {
                cardioRisk, cardioModifiers, neutroRisk, neutroModifiers,
                anemiaRisk, nauseaRisk, fatigueRisk, mucositisRisk, overallScore,
                // GLS Assessment Data
                glsAssessment: glsAssessment,
                glsRelativeChange: glsAssessment.relativeChange,
                glsStatus: glsAssessment.absoluteStatus,
                glsChangeSignificance: glsAssessment.changeSignificance,
                isGLSCardiotoxicity: glsAssessment.isSignificantCardiotoxicity
            };
        }

        // Initialize patient with cancer subtype and GLS
        function initializePatient(id) {
            return {
                id: id,
                age: 45,
                sex: 'male',
                cancer: 'leukemia',
                cancerSubtype: 'ALL',
                chronicDiseases: [],
                vitals: {
                    temperature: 37.0,
                    bloodPressure: '120/80',
                    heartRate: 75
                },
                ejectionFraction: 60,
                baselineGLS: -21.0,  // Normal baseline GLS (pre-treatment)
                currentGLS: -21.0,   // Current GLS (will decrease with cardiotoxicity)
                cumulativeDose: 0,
                sessions: [],
                createdAt: new Date().toISOString()
            };
        }

        // Load patient function
        async function loadPatient() {
            const patientId = document.getElementById('patientId').value.trim();
            
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }
            
            try {
                // Try to use localStorage if available
                const storedPatient = localStorage.getItem(`patient:${patientId}`);
                if (storedPatient) {
                    currentPatient = JSON.parse(storedPatient);
                    alert(`Patient ${patientId} loaded!\n\nSessions: ${currentPatient.sessions.length}\nDose: ${currentPatient.cumulativeDose} mg/m²`);
                } else {
                    currentPatient = initializePatient(patientId);
                    localStorage.setItem(`patient:${patientId}`, JSON.stringify(currentPatient));

                    console.log('New patient created, sending email notification...');
                    try {
                        await sendEmailNotification({
                            patientId: currentPatient.id,
                            timestamp: currentPatient.createdAt,
                            age: currentPatient.age,
                            sex: currentPatient.sex,
                            cancer: currentPatient.cancer,
                            cancerSubtype: currentPatient.cancerSubtype,
                            chronicDiseases: currentPatient.chronicDiseases,
                            vitals: currentPatient.vitals,
                            ejectionFraction: currentPatient.ejectionFraction,
                            sessions: currentPatient.sessions,
                            cumulativeDose: currentPatient.cumulativeDose,
                            latestRisks: {}
                        });
                        alert(`New patient ${patientId} created!\n\nEmail notification sent.`);
                    } catch (error) {
                        console.error('Failed to send email for new patient:', error);
                        alert(`New patient ${patientId} created!\n\n(Email notification failed - check console)`);
                    }
                }
            } catch (error) {
                currentPatient = initializePatient(patientId);
                alert(`New patient ${patientId} created!`);
            }
            
            updateUI();
            // Calculate current status immediately
            if (currentPatient) {
                runSimulation();
            }
        }

        // Generate new patient (renamed from generateVirtualPatient)
        function generateNewPatient() {
            const randomId = 'PT-2025-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            document.getElementById('patientId').value = randomId;
            
            const patient = initializePatient(randomId);
            patient.age = Math.floor(Math.random() * 60) + 20;
            patient.sex = Math.random() > 0.5 ? 'male' : 'female';
            patient.cancer = ['leukemia', 'lymphoma'][Math.floor(Math.random() * 2)];
            
            // Set random cancer subtype based on cancer type
            if (patient.cancer === 'leukemia') {
                const leukemiaSubtypes = ['ALL', 'AML', 'CLL', 'CML', 'Other Leukemia'];
                patient.cancerSubtype = leukemiaSubtypes[Math.floor(Math.random() * leukemiaSubtypes.length)];
            } else {
                const lymphomaSubtypes = ['HL', 'NHL', 'Other Lymphoma'];
                patient.cancerSubtype = lymphomaSubtypes[Math.floor(Math.random() * lymphomaSubtypes.length)];
            }
            
            if (Math.random() > 0.7) patient.chronicDiseases.push('diabetes');
            if (Math.random() > 0.6) patient.chronicDiseases.push('hypertension');
            if (Math.random() > 0.8) patient.chronicDiseases.push('anemia');
            
            patient.vitals.temperature = (36.5 + Math.random() * 1.5).toFixed(1);
            patient.vitals.bloodPressure = `${Math.floor(Math.random() * 40) + 110}/${Math.floor(Math.random() * 30) + 70}`;
            patient.vitals.heartRate = Math.floor(Math.random() * 40) + 60;
            patient.ejectionFraction = Math.floor(Math.random() * 30) + 45; // 45-75%
            
            // GLS values - baseline normal range (-18 to -24%), current may show deterioration
            patient.baselineGLS = -(18 + Math.random() * 6).toFixed(1); // -18% to -24%
            // Current GLS slightly worse than baseline for realistic simulation
            const glsDegradation = Math.random() * 4; // 0-4% degradation
            patient.currentGLS = (parseFloat(patient.baselineGLS) + glsDegradation).toFixed(1);
            // Ensure current GLS is not more negative than baseline
            if (parseFloat(patient.currentGLS) < parseFloat(patient.baselineGLS)) {
                patient.currentGLS = patient.baselineGLS;
            }
            
            currentPatient = patient;
            savePatientData();

            // Send email notification with await and error handling
            (async () => {
                try {
                    await sendEmailNotification({
                        patientId: currentPatient.id,
                        timestamp: currentPatient.createdAt,
                        age: currentPatient.age,
                        sex: currentPatient.sex,
                        cancer: currentPatient.cancer,
                        cancerSubtype: currentPatient.cancerSubtype,
                        chronicDiseases: currentPatient.chronicDiseases,
                        vitals: currentPatient.vitals,
                        ejectionFraction: currentPatient.ejectionFraction,
                        baselineGLS: currentPatient.baselineGLS,
                        currentGLS: currentPatient.currentGLS,
                        sessions: currentPatient.sessions,
                        cumulativeDose: currentPatient.cumulativeDose,
                        latestRisks: {}
                    });
                    console.log('Email notification sent for new patient:', randomId);
                } catch (error) {
                    console.error('Failed to send email for new patient:', error);
                }
            })();

            updateUI();
            // Calculate current status immediately
            runSimulation();
        }

        // Save patient data function
        async function savePatientData() {
            if (!currentPatient) return;
            
            try {
                localStorage.setItem(`patient:${currentPatient.id}`, JSON.stringify(currentPatient));
            } catch (error) {
                console.log('Data stored in session');
            }
        }

        // Update UI with cancer subtype
        function updateUI() {
            if (!currentPatient) return;
            
            document.getElementById('patientProfileSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'grid';
            document.getElementById('patientForm').classList.add('active');
            document.getElementById('resultsArea').classList.add('active');
            document.getElementById('exportBtn').style.display = 'inline-block';
            document.getElementById('bluetoothSidebar').classList.add('active');
            
            // Show/hide first session prompt based on sessions
            const firstSessionPrompt = document.getElementById('firstSessionPrompt');
            if (firstSessionPrompt) {
                firstSessionPrompt.style.display = currentPatient.sessions.length === 0 ? 'block' : 'none';
            }
            
            document.getElementById('currentPatientId').textContent = currentPatient.id;
            document.getElementById('age').value = currentPatient.age;
            document.getElementById('sex').value = currentPatient.sex;
            document.getElementById('cancer').value = currentPatient.cancer;
            document.getElementById('temperature').value = currentPatient.vitals.temperature;
            document.getElementById('bloodPressure').value = currentPatient.vitals.bloodPressure;
            document.getElementById('heartRate').value = currentPatient.vitals.heartRate;
            document.getElementById('ejectionFraction').value = currentPatient.ejectionFraction;
            
            // Set GLS values (with defaults for existing patients)
            document.getElementById('baselineGLS').value = currentPatient.baselineGLS || -21.0;
            document.getElementById('currentGLS').value = currentPatient.currentGLS || -21.0;
            
            // Update GLS indicator
            updateGLSChangeIndicator();
            
            // Set cancer subtype
            const subtypeRadios = document.getElementsByName('cancerSubtype');
            for (let radio of subtypeRadios) {
                if (radio.value === currentPatient.cancerSubtype) {
                    radio.checked = true;
                    break;
                }
            }
            
            updateSidebarVitals();
            
            const chronicSelect = document.getElementById('chronicDiseases');
            Array.from(chronicSelect.options).forEach(option => {
                option.selected = currentPatient.chronicDiseases.includes(option.value);
            });

            // Deselect "none" if other diseases are selected
            if (currentPatient.chronicDiseases.length > 0 && !currentPatient.chronicDiseases.includes('none')) {
                Array.from(chronicSelect.options).forEach(option => {
                    if (option.value === 'none') option.selected = false;
                });
            }
            
            updateDoseDisplay();
            document.getElementById('sessionCount').textContent = currentPatient.sessions.length;
            
            // Show appropriate cancer subtype section
            toggleCancerSubtypes();
        }

        // Update sidebar vitals with ejection fraction and GLS
        function updateSidebarVitals() {
            if (!currentPatient) return;
            document.getElementById('sidebarHR').textContent = currentPatient.vitals.heartRate + ' bpm';
            document.getElementById('sidebarBP').textContent = currentPatient.vitals.bloodPressure;
            document.getElementById('sidebarTemp').textContent = currentPatient.vitals.temperature + ' °C';
            document.getElementById('sidebarEF').textContent = currentPatient.ejectionFraction + ' %';
            
            // GLS display
            const currentGLS = currentPatient.currentGLS || -21.0;
            const baselineGLS = currentPatient.baselineGLS || -21.0;
            document.getElementById('sidebarGLS').textContent = currentGLS.toFixed(1) + ' %';
            
            // Calculate and display GLS relative change
            const glsRelativeChange = calculateGLSRelativeChange(baselineGLS, currentGLS);
            const glsChangeEl = document.getElementById('sidebarGLSChange');
            glsChangeEl.textContent = (glsRelativeChange >= 0 ? '+' : '') + glsRelativeChange.toFixed(1) + '%';
            
            // Color coding based on GLS change significance
            if (glsRelativeChange >= 15) {
                glsChangeEl.style.color = '#dc2626'; // Red - significant cardiotoxicity
            } else if (glsRelativeChange >= 10) {
                glsChangeEl.style.color = '#f59e0b'; // Orange - warning
            } else {
                glsChangeEl.style.color = '#10b981'; // Green - normal
            }
        }

        // Update patient realtime with cancer subtype and GLS
        function updatePatientRealtime() {
            if (!currentPatient) return;
            
            currentPatient.age = parseInt(document.getElementById('age').value) || 45;
            currentPatient.sex = document.getElementById('sex').value;
            currentPatient.cancer = document.getElementById('cancer').value;
            currentPatient.vitals.temperature = parseFloat(document.getElementById('temperature').value) || 37.0;
            currentPatient.vitals.bloodPressure = document.getElementById('bloodPressure').value || '120/80';
            currentPatient.vitals.heartRate = parseInt(document.getElementById('heartRate').value) || 75;
            currentPatient.ejectionFraction = parseInt(document.getElementById('ejectionFraction').value) || 60;
            
            // GLS values (negative percentages)
            currentPatient.baselineGLS = parseFloat(document.getElementById('baselineGLS').value) || -21.0;
            currentPatient.currentGLS = parseFloat(document.getElementById('currentGLS').value) || -21.0;
            
            // Update GLS change indicator
            updateGLSChangeIndicator();
            
            // Get cancer subtype
            const subtypeRadios = document.getElementsByName('cancerSubtype');
            for (let radio of subtypeRadios) {
                if (radio.checked) {
                    currentPatient.cancerSubtype = radio.value;
                    break;
                }
            }
            
            const chronicSelect = document.getElementById('chronicDiseases');
            currentPatient.chronicDiseases = Array.from(chronicSelect.selectedOptions).map(opt => opt.value).filter(v => v !== 'none');
            
            updateSidebarVitals();
            savePatientData();
            
            // Calculate current status immediately when inputs change
            runSimulation();
        }
        
        // Update GLS Change Indicator in real-time
        function updateGLSChangeIndicator() {
            const baselineGLS = parseFloat(document.getElementById('baselineGLS').value) || -21.0;
            const currentGLS = parseFloat(document.getElementById('currentGLS').value) || -21.0;
            
            const indicator = document.getElementById('glsChangeIndicator');
            if (!indicator) return;
            
            const relativeChange = calculateGLSRelativeChange(baselineGLS, currentGLS);
            const absoluteStatus = assessAbsoluteGLSStatus(currentGLS);
            const changeSignificance = assessGLSChangeSignificance(relativeChange);
            
            let html = '';
            
            // Relative change display
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
            html += `<span style="font-weight: 600; color: #475569;">Relative Change:</span>`;
            html += `<span style="font-weight: 700; font-size: 1.2em; color: ${changeSignificance.color};">${relativeChange >= 0 ? '+' : ''}${relativeChange.toFixed(1)}%</span>`;
            html += `</div>`;
            
            // Status assessment
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
            html += `<span style="font-weight: 600; color: #475569;">Current Status:</span>`;
            html += `<span style="font-weight: 600; color: ${absoluteStatus.color}; background: ${absoluteStatus.color}20; padding: 2px 10px; border-radius: 12px;">${absoluteStatus.label}</span>`;
            html += `</div>`;
            
            // Significance assessment
            if (changeSignificance.status !== 'normal') {
                html += `<div style="margin-top: 10px; padding: 10px; background: ${changeSignificance.color}15; border-left: 4px solid ${changeSignificance.color}; border-radius: 4px;">`;
                html += `<div style="font-weight: 700; color: ${changeSignificance.color}; margin-bottom: 5px;">${changeSignificance.label}</div>`;
                html += `<div style="font-size: 0.85em; color: #475569;">${changeSignificance.description}</div>`;
                html += `<div style="font-size: 0.8em; color: #64748b; margin-top: 5px; font-style: italic;">Recommendation: ${changeSignificance.recommendation}</div>`;
                html += `</div>`;
            }
            
            // Show warning for significant cardiotoxicity
            if (relativeChange >= 15) {
                html += `<div style="margin-top: 10px; padding: 12px; background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px;">`;
                html += `<div style="font-weight: 700; color: #dc2626; display: flex; align-items: center; gap: 8px;">`;
                html += `<span style="font-weight: 700; color: #dc2626;">[ALERT]</span> CARDIOTOXICITY THRESHOLD EXCEEDED`;
                html += `</div>`;
                html += `<div style="font-size: 0.85em; color: #7f1d1d; margin-top: 5px;">`;
                html += `≥15% GLS reduction from baseline indicates subclinical left ventricular dysfunction (per ASE/EACVI guidelines)`;
                html += `</div>`;
                html += `</div>`;
            }
            
            indicator.innerHTML = html;
            indicator.style.display = 'block';
        }

        // Update dose display
        function updateDoseDisplay() {
            if (!currentPatient) return;
            const dose = currentPatient.cumulativeDose;
            const maxDose = 550;
            const percentage = Math.min(100, (dose / maxDose) * 100);
            
            document.getElementById('cumulativeDoseDisplay').textContent = `${dose} mg/m²`;
            document.getElementById('doseProgressBar').style.width = `${percentage}%`;
            
            const progressBar = document.getElementById('doseProgressBar');
            if (percentage < 60) {
                progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (percentage < 80) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }
        }

        // Add treatment session with custom dose
        async function addTreatmentSession() {
            if (!currentPatient) {
                alert('Please load or create a patient first!');
                return;
            }
            
            const sessionDoseInput = document.getElementById('sessionDose');
            const sessionDose = parseInt(sessionDoseInput.value) || 60;
            
            if (sessionDose <= 0) {
                alert('Please enter a valid dose greater than 0');
                return;
            }
            
            if (currentPatient.cumulativeDose + sessionDose > 600) {
                if (!confirm(`WARNING: High Dose Alert!\n\nCumulative dose will reach ${currentPatient.cumulativeDose + sessionDose} mg/m²\n\nThis EXCEEDS 550 mg/m² maximum.\n\nContinue?`)) {
                    return;
                }
            }
            
            currentPatient.cumulativeDose += sessionDose;
            
            const risks = calculateDigitalTwinRisks(currentPatient);
            
            const session = {
                date: new Date().toISOString(),
                sessionNumber: currentPatient.sessions.length + 1,
                dose: sessionDose,
                cumulativeDose: currentPatient.cumulativeDose,
                vitals: { ...currentPatient.vitals },
                ejectionFraction: currentPatient.ejectionFraction,
                baselineGLS: currentPatient.baselineGLS || -21.0,
                currentGLS: currentPatient.currentGLS || -21.0,
                cancerSubtype: currentPatient.cancerSubtype,
                risks: risks
            };
            
            currentPatient.sessions.push(session);

            await savePatientData();

            console.log('Treatment session added, sending email notification...');
            try {
                await sendEmailNotification({
                    patientId: currentPatient.id,
                    timestamp: session.date,
                    age: currentPatient.age,
                    sex: currentPatient.sex,
                    cancer: currentPatient.cancer,
                    cancerSubtype: currentPatient.cancerSubtype,
                    chronicDiseases: currentPatient.chronicDiseases,
                    vitals: currentPatient.vitals,
                    ejectionFraction: currentPatient.ejectionFraction,
                    baselineGLS: currentPatient.baselineGLS,
                    currentGLS: currentPatient.currentGLS,
                    glsRelativeChange: risks.glsRelativeChange,
                    isGLSCardiotoxicity: risks.isGLSCardiotoxicity,
                    sessions: currentPatient.sessions,
                    cumulativeDose: currentPatient.cumulativeDose,
                    latestRisks: risks
                });
                console.log('Treatment session email notification sent successfully!');
            } catch (error) {
                console.error('Failed to send email for treatment session:', error);
            }

            updateDoseDisplay();
            document.getElementById('sessionCount').textContent = currentPatient.sessions.length;
            
            // Hide the first session prompt after adding a session
            const firstSessionPrompt = document.getElementById('firstSessionPrompt');
            if (firstSessionPrompt) {
                firstSessionPrompt.style.display = 'none';
            }

            runSimulation();
        }

        // Run simulation for current patient
        function runSimulation() {
            if (!currentPatient) return;
            
            const risks = calculateDigitalTwinRisks(currentPatient);
            
            document.getElementById('cardioRisk').textContent = risks.cardioRisk + '%';
            document.getElementById('neutroRisk').textContent = risks.neutroRisk + '%';
            document.getElementById('anemiaRisk').textContent = risks.anemiaRisk + '%';
            document.getElementById('qualityScore').textContent = risks.overallScore;
            
            displayDigitalTwinAnalysis(risks);
            displayAlerts(risks);
            displayResearchCalculations(risks);
            displaySessionHistory();
            updateCharts();
            updatePatientView(risks);
        }

        // Display digital twin analysis with cancer subtype and GLS
        function displayDigitalTwinAnalysis(risks) {
            const container = document.getElementById('digitalTwinAnalysis');
            
            // Get GLS values
            const baselineGLS = currentPatient.baselineGLS || -21.0;
            const currentGLS = currentPatient.currentGLS || -21.0;
            const glsRelativeChange = risks.glsRelativeChange || 0;
            const glsStatus = risks.glsStatus || { label: 'Normal', color: '#10b981' };
            const glsChangeSignificance = risks.glsChangeSignificance || { label: 'Stable', color: '#10b981' };
            
            let html = '<div class="twin-analysis-box">';
            html += '<h4>Digital Twin Personalized Analysis</h4>';
            html += `<p><strong>${currentPatient.id}</strong> | ${currentPatient.age}yo ${currentPatient.sex} | ${currentPatient.cancer} (${currentPatient.cancerSubtype}) | ${currentPatient.cumulativeDose} mg/m² | EF: ${currentPatient.ejectionFraction}%</p>`;
            
            // GLS Assessment Box - Primary cardiotoxicity indicator
            html += `<div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px solid #f59e0b;">`;
            html += `<h5 style="color: #92400e; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">`;
            html += ` Global Longitudinal Strain (GLS) Assessment`;
            html += `<span style="font-size: 0.7em; background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px;">PRIMARY CARDIOTOXICITY INDICATOR</span>`;
            html += `</h5>`;
            
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 10px;">`;
            html += `<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">`;
            html += `<div style="font-size: 0.8em; color: #64748b;">Baseline GLS</div>`;
            html += `<div style="font-size: 1.4em; font-weight: 700; color: #1e293b;">${baselineGLS.toFixed(1)}%</div>`;
            html += `</div>`;
            html += `<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">`;
            html += `<div style="font-size: 0.8em; color: #64748b;">Current GLS</div>`;
            html += `<div style="font-size: 1.4em; font-weight: 700; color: ${glsStatus.color};">${currentGLS.toFixed(1)}%</div>`;
            html += `</div>`;
            html += `<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">`;
            html += `<div style="font-size: 0.8em; color: #64748b;">Relative Change</div>`;
            html += `<div style="font-size: 1.4em; font-weight: 700; color: ${glsChangeSignificance.color};">${glsRelativeChange >= 0 ? '+' : ''}${glsRelativeChange.toFixed(1)}%</div>`;
            html += `</div>`;
            html += `<div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">`;
            html += `<div style="font-size: 0.8em; color: #64748b;">Status</div>`;
            html += `<div style="font-size: 1.1em; font-weight: 700; color: ${glsStatus.color};">${glsStatus.label}</div>`;
            html += `</div>`;
            html += `</div>`;
            
            // Cardiotoxicity warning if detected
            if (risks.isGLSCardiotoxicity) {
                html += `<div style="background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px; padding: 12px; margin-top: 10px;">`;
                html += `<div style="color: #dc2626; font-weight: 700; display: flex; align-items: center; gap: 8px;">`;
                html += `<span style="font-weight: 700; color: #dc2626;">[ALERT]</span> CARDIOTOXICITY THRESHOLD EXCEEDED`;
                html += `</div>`;
                html += `<div style="color: #7f1d1d; font-size: 0.9em; margin-top: 8px;">`;
                html += `${glsChangeSignificance.label}: ${glsChangeSignificance.description || ''}`;
                html += `</div>`;
                html += `<div style="color: #7f1d1d; font-size: 0.85em; margin-top: 5px; font-style: italic;">`;
                html += `Recommendation: ${glsChangeSignificance.recommendation || 'Consider cardiology consultation'}`;
                html += `</div>`;
                html += `</div>`;
            }
            
            html += `</div>`; // End GLS box
            
            if (risks.cardioModifiers && risks.cardioModifiers.length > 0) {
                html += '<p><strong>Cardiotoxicity Factors:</strong></p>';
                risks.cardioModifiers.forEach(mod => html += `<div class="calculation-step">${mod}</div>`);
            }
            
            if (risks.neutroModifiers && risks.neutroModifiers.length > 0) {
                html += '<p><strong>Neutropenia Factors:</strong></p>';
                risks.neutroModifiers.forEach(mod => html += `<div class="calculation-step">${mod}</div>`);
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Display alerts with cancer subtype and GLS considerations
        function displayAlerts(risks) {
            const alertsContainer = document.getElementById('clinicalAlerts');
            alertsContainer.innerHTML = '';
            
            // GLS-based cardiotoxicity alert (PRIMARY INDICATOR - highest priority)
            if (risks.isGLSCardiotoxicity) {
                const glsAlert = document.createElement('div');
                glsAlert.className = 'alert';
                glsAlert.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)';
                glsAlert.style.borderColor = '#dc2626';
                let glsAlertText = '<h4 style="color: #dc2626;">[CRITICAL] GLS CARDIOTOXICITY ALERT (PRIMARY INDICATOR)</h4>';
                glsAlertText += `<p><strong>GLS Relative Change: ${(risks.glsRelativeChange || 0) >= 0 ? '+' : ''}${(risks.glsRelativeChange || 0).toFixed(1)}%</strong> (≥15% = significant)</p>`;
                glsAlertText += `<p><strong>Current GLS: ${(currentPatient.currentGLS || -21).toFixed(1)}%</strong> | Status: ${(risks.glsStatus || {}).label || 'N/A'}</p>`;
                glsAlertText += '<p><strong>Clinical Significance:</strong></p>';
                glsAlertText += '<ul>';
                glsAlertText += '<li><strong>Per ASE/EACVI Guidelines:</strong> ≥15% GLS reduction from baseline indicates subclinical LV dysfunction</li>';
                glsAlertText += '<li>GLS detects cardiotoxicity 2-3 months BEFORE ejection fraction decreases</li>';
                glsAlertText += '</ul>';
                glsAlertText += '<p><strong>Immediate Actions Required:</strong></p>';
                glsAlertText += '<ul>';
                glsAlertText += '<li>URGENT CARDIOLOGY CONSULTATION</li>';
                glsAlertText += '<li>Consider dose reduction or treatment modification</li>';
                glsAlertText += '<li>Initiate cardioprotective therapy (dexrazoxane, ACE inhibitors, beta-blockers)</li>';
                glsAlertText += '<li>Schedule follow-up echocardiogram within 2-4 weeks</li>';
                glsAlertText += '<li>Monitor serial GLS and troponin levels</li>';
                glsAlertText += '</ul>';
                glsAlert.innerHTML = glsAlertText;
                alertsContainer.appendChild(glsAlert);
            }
            
            if (risks.cardioRisk > 20 || currentPatient.ejectionFraction < 50) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                let alertText = '<h4>CARDIOTOXICITY ALERT</h4>';
                alertText += `<p><strong>Risk: ${risks.cardioRisk}%</strong></p>`;
                if (currentPatient.ejectionFraction < 50) {
                    alertText += `<p><strong>Critical Ejection Fraction: ${currentPatient.ejectionFraction}% (Normal: 55-70%)</strong></p>`;
                }
                alertText += '<p><strong>Actions Required:</strong></p>';
                alertText += '<ul>';
                alertText += '<li>Consider dexrazoxane cardioprotection</li>';
                alertText += '<li>Schedule echocardiogram within 1 week</li>';
                alertText += '<li>Monitor troponin I levels</li>';
                alertText += '<li>Evaluate ACE inhibitor prophylaxis</li>';
                if (currentPatient.ejectionFraction < 50) {
                    alertText += '<li>CARDIOLOGY CONSULT URGENTLY REQUIRED</li>';
                }
                alertText += '</ul>';
                alert.innerHTML = alertText;
                alertsContainer.appendChild(alert);
            }
            
            if (risks.neutroRisk > 60) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>NEUTROPENIA ALERT</h4>
                    <p><strong>Risk: ${risks.neutroRisk}%</strong></p>
                    <p><strong>Actions Required:</strong></p>
                    <ul>
                        <li>Prophylactic G-CSF recommended</li>
                        <li>Monitor CBC on days 7, 10, 14</li>
                        <li>Consider prophylactic antibiotics</li>
                        <li>Patient fever protocol education</li>
                    </ul>
                `;
                alertsContainer.appendChild(alert);
            }
            
            if (risks.anemiaRisk > 70 || currentPatient.chronicDiseases.includes('anemia')) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>ANEMIA ALERT</h4>
                    <p><strong>Risk: ${risks.anemiaRisk}%</strong></p>
                    ${currentPatient.chronicDiseases.includes('anemia') ? '<p><strong>Pre-existing anemia condition detected</strong></p>' : ''}
                    <p><strong>Actions Required:</strong></p>
                    <ul>
                        <li>Monitor hemoglobin levels weekly</li>
                        <li>Consider erythropoietin stimulating agents</li>
                        <li>Evaluate for iron supplementation</li>
                        <li>Plan for potential transfusion needs</li>
                    </ul>
                `;
                alertsContainer.appendChild(alert);
            }
            
            // Cancer subtype-specific alerts
            if (currentPatient.cancer === 'leukemia' && currentPatient.cancerSubtype === 'AML') {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>AML-SPECIFIC CONSIDERATIONS</h4>
                    <p><strong>Acute Myeloid Leukemia requires specific monitoring</strong></p>
                    <ul>
                        <li>High risk of differentiation syndrome with certain agents</li>
                        <li>Monitor for tumor lysis syndrome</li>
                        <li>Consider antifungal prophylaxis during neutropenic periods</li>
                        <li>Higher risk of CNS involvement - consider lumbar puncture</li>
                    </ul>
                `;
                alertsContainer.appendChild(alert);
            }
            
            if (currentPatient.cancer === 'lymphoma' && currentPatient.cancerSubtype === 'HL') {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>HODGKIN LYMPHOMA CONSIDERATIONS</h4>
                    <p><strong>Specific monitoring for Hodgkin Lymphoma patients</strong></p>
                    <ul>
                        <li>Increased risk of secondary malignancies with certain regimens</li>
                        <li>Monitor for pulmonary toxicity with bleomycin</li>
                        <li>Higher risk of infertility - consider fertility preservation</li>
                        <li>Increased risk of thyroid dysfunction post-treatment</li>
                    </ul>
                `;
                alertsContainer.appendChild(alert);
            }
        }

        // Display research calculations with accordion style
        function displayResearchCalculations(risks) {
            const container = document.getElementById('researchCalculationsContainer');
            container.innerHTML = '';
            
            const systolic = parseInt(currentPatient.vitals.bloodPressure.split('/')[0]);
            
            // Build cardiotoxicity details
            let cardioDetails = '';
            cardioDetails += `<div class="calc-step"><strong>Step 1 - Cumulative Dose Effect:</strong><br>Current dose: ${currentPatient.cumulativeDose} mg/m²<br>`;
            if (currentPatient.cumulativeDose <= 200) {
                cardioDetails += '≤200 mg/m² = Base risk: 1%</div>';
            } else if (currentPatient.cumulativeDose <= 300) {
                cardioDetails += '200-300 mg/m² = Base risk: 5%</div>';
            } else if (currentPatient.cumulativeDose <= 450) {
                cardioDetails += '300-450 mg/m² = Base risk: 12%</div>';
            } else if (currentPatient.cumulativeDose <= 550) {
                cardioDetails += '450-550 mg/m² = Base risk: 24%</div>';
            } else {
                cardioDetails += '>550 mg/m² = Base risk: 36% - Above safe limit!</div>';
            }
            
            let modifiers = [];
            if (currentPatient.age < 18) modifiers.push(`Pediatric age (${currentPatient.age}): +8%`);
            else if (currentPatient.age > 65) modifiers.push(`Elderly (${currentPatient.age}): +10%`);
            if (currentPatient.sex === 'female') modifiers.push('Female sex: +4%');
            if (currentPatient.ejectionFraction < 50) modifiers.push(`Low EF (${currentPatient.ejectionFraction}%): +15%`);
            else if (currentPatient.ejectionFraction < 55) modifiers.push(`Borderline EF (${currentPatient.ejectionFraction}%): +5%`);
            cardioDetails += `<div class="calc-step"><strong>Step 2 - Patient Modifiers:</strong><br>${modifiers.length ? modifiers.join('<br>') : 'No additional modifiers'}</div>`;
            
            let cancerImpact = 'No additional cardiac risk';
            if (currentPatient.cancer === 'leukemia' && currentPatient.cancerSubtype === 'AML') cancerImpact = 'AML subtype: +6%';
            else if (currentPatient.cancer === 'leukemia' && currentPatient.cancerSubtype === 'CML') cancerImpact = 'CML subtype: +4%';
            else if (currentPatient.cancer === 'lymphoma' && currentPatient.cancerSubtype === 'HL') cancerImpact = 'Hodgkin Lymphoma: +5%';
            cardioDetails += `<div class="calc-step"><strong>Step 3 - Cancer Subtype:</strong><br>${cancerImpact}</div>`;
            
            let diseases = [];
            if (currentPatient.chronicDiseases.includes('diabetes')) diseases.push('Diabetes: +12%');
            if (currentPatient.chronicDiseases.includes('hypertension')) diseases.push('Hypertension: +10%');
            if (currentPatient.chronicDiseases.includes('heart_disease')) diseases.push('Heart disease: +15%');
            if (currentPatient.chronicDiseases.includes('kidney_disease')) diseases.push('Kidney disease: +8%');
            if (currentPatient.chronicDiseases.includes('obesity')) diseases.push('Obesity: +7%');
            cardioDetails += `<div class="calc-step"><strong>Step 4 - Chronic Diseases:</strong><br>${diseases.length ? diseases.join('<br>') : 'None'}</div>`;
            
            let vitals = [];
            if (systolic > 140) vitals.push(`Elevated BP (${currentPatient.vitals.bloodPressure}): +6%`);
            if (currentPatient.vitals.heartRate > 100) vitals.push(`Tachycardia (${currentPatient.vitals.heartRate} bpm): +5%`);
            cardioDetails += `<div class="calc-step"><strong>Step 5 - Vital Signs:</strong><br>${vitals.length ? vitals.join('<br>') : 'Normal - no additional risk'}</div>`;
            
            const cardioRiskClass = risks.cardioRisk > 20 ? 'high-risk' : risks.cardioRisk > 10 ? 'medium-risk' : 'low-risk';
            cardioDetails += `<div class="calc-result ${cardioRiskClass}">Final Cardiotoxicity Risk: ${risks.cardioRisk}%${risks.cardioRisk > 20 ? ' - Cardioprotective measures recommended' : ''}</div>`;
            
            // Build neutropenia details
            let neutroDetails = '';
            neutroDetails += `<div class="calc-step"><strong>Baseline Calculation:</strong><br>`;
            neutroDetails += `Baseline risk: 35%<br>`;
            neutroDetails += `Dose contribution: (${currentPatient.cumulativeDose}/600) × 45% = ${Math.round((currentPatient.cumulativeDose/600)*45)}%</div>`;
            
            let neutroFactors = [];
            if (currentPatient.age > 65) neutroFactors.push(`Age (${currentPatient.age}): +12%`);
            if (currentPatient.cancer === 'leukemia') {
                neutroFactors.push('Leukemia: +18%');
                if (currentPatient.cancerSubtype === 'ALL') neutroFactors.push('ALL subtype: +8%');
                else if (currentPatient.cancerSubtype === 'AML') neutroFactors.push('AML subtype: +12%');
            } else if (currentPatient.cancer === 'lymphoma') {
                neutroFactors.push('Lymphoma: +10%');
                if (currentPatient.cancerSubtype === 'NHL') neutroFactors.push('NHL subtype: +6%');
            }
            if (currentPatient.chronicDiseases.includes('diabetes')) neutroFactors.push('Diabetes: +8%');
            if (currentPatient.chronicDiseases.includes('kidney_disease')) neutroFactors.push('Kidney disease: +10%');
            if (currentPatient.chronicDiseases.includes('liver_disease')) neutroFactors.push('Liver disease: +9%');
            neutroDetails += `<div class="calc-step"><strong>Risk Modifiers:</strong><br>${neutroFactors.length ? neutroFactors.join('<br>') : 'No additional factors'}</div>`;
            
            const neutroRiskClass = risks.neutroRisk > 60 ? 'high-risk' : risks.neutroRisk > 40 ? 'medium-risk' : 'low-risk';
            neutroDetails += `<div class="calc-result ${neutroRiskClass}">Final Neutropenia Risk: ${risks.neutroRisk}%${risks.neutroRisk > 60 ? ' - G-CSF prophylaxis recommended' : ''}</div>`;
            
            // Build anemia details
            let anemiaDetails = '';
            anemiaDetails += `<div class="calc-step"><strong>Baseline Calculation:</strong><br>`;
            anemiaDetails += `Baseline risk: 30%<br>`;
            anemiaDetails += `Dose contribution: (${currentPatient.cumulativeDose}/600) × 45% = ${Math.round((currentPatient.cumulativeDose/600)*45)}%</div>`;
            
            let anemiaFactors = [];
            if (currentPatient.sex === 'female') anemiaFactors.push('Female sex: +8%');
            if (currentPatient.cancer === 'leukemia') {
                anemiaFactors.push('Leukemia: +15%');
                if (currentPatient.cancerSubtype === 'AML') anemiaFactors.push('AML subtype: +8%');
            }
            if (currentPatient.chronicDiseases.includes('anemia')) anemiaFactors.push('Pre-existing anemia: +25%');
            anemiaDetails += `<div class="calc-step"><strong>Risk Modifiers:</strong><br>${anemiaFactors.length ? anemiaFactors.join('<br>') : 'No additional factors'}</div>`;
            
            const anemiaRiskClass = risks.anemiaRisk > 70 ? 'high-risk' : risks.anemiaRisk > 50 ? 'medium-risk' : 'low-risk';
            anemiaDetails += `<div class="calc-result ${anemiaRiskClass}">Final Anemia Risk: ${risks.anemiaRisk}%${risks.anemiaRisk > 70 ? ' - Monitor hemoglobin closely' : ''}</div>`;
            
            // Build info section
            let infoDetails = '';
            infoDetails += `<div class="calc-step"><strong>Personalization:</strong> Each patient is unique - same dose affects people differently based on age, sex, health conditions, and cancer subtype</div>`;
            infoDetails += `<div class="calc-step"><strong>Cancer-Specific:</strong> Different leukemia and lymphoma subtypes have unique risk profiles requiring tailored monitoring</div>`;
            infoDetails += `<div class="calc-step"><strong>Prevention:</strong> By calculating risks early, we can take protective measures BEFORE problems occur</div>`;
            infoDetails += `<div class="calc-step"><strong>Evidence-Based:</strong> All calculations based on peer-reviewed clinical studies</div>`;
            infoDetails += `<div class="calc-step"><strong>Dynamic:</strong> Risks update in real-time as treatment progresses and vitals change</div>`;
            
            // Build GLS calculation details
            const baselineGLS = currentPatient.baselineGLS || -21.0;
            const currentGLS = currentPatient.currentGLS || -21.0;
            const glsRelChange = risks.glsRelativeChange || 0;
            const glsStatus = risks.glsStatus || { label: 'Normal', color: '#10b981' };
            const glsChangeSig = risks.glsChangeSignificance || { label: 'Stable', color: '#10b981' };
            
            let glsDetails = '';
            glsDetails += `<div class="calc-step" style="background: #fef3c7; border-left-color: #f59e0b;"><strong> What is GLS?</strong><br>`;
            glsDetails += `Global Longitudinal Strain (GLS) measures how much the heart muscle contracts and deforms during each heartbeat.<br>`;
            glsDetails += `<strong>Normal values:</strong> -20% to -22% (more negative = better function)<br>`;
            glsDetails += `<strong>Key advantage:</strong> Detects cardiotoxicity 2-3 months BEFORE ejection fraction drops</div>`;
            
            glsDetails += `<div class="calc-step"><strong>Step 1 - Baseline GLS (Pre-treatment):</strong><br>`;
            glsDetails += `Patient's baseline GLS: <strong>${baselineGLS.toFixed(1)}%</strong><br>`;
            glsDetails += `Reference range: -20% to -22%</div>`;
            
            glsDetails += `<div class="calc-step"><strong>Step 2 - Current GLS Measurement:</strong><br>`;
            glsDetails += `Current GLS: <strong>${currentGLS.toFixed(1)}%</strong><br>`;
            glsDetails += `Status: <span style="color: ${glsStatus.color}; font-weight: 600;">${glsStatus.label}</span></div>`;
            
            glsDetails += `<div class="calc-step"><strong>Step 3 - Relative Change Calculation:</strong><br>`;
            glsDetails += `<strong>Formula:</strong> ((Current GLS - Baseline GLS) / |Baseline GLS|) × 100<br>`;
            glsDetails += `Calculation: ((${currentGLS.toFixed(1)}) - (${baselineGLS.toFixed(1)})) / |${baselineGLS.toFixed(1)}| × 100<br>`;
            glsDetails += `<strong>Result: ${glsRelChange >= 0 ? '+' : ''}${glsRelChange.toFixed(1)}%</strong></div>`;
            
            glsDetails += `<div class="calc-step"><strong>Step 4 - Clinical Significance (ASE/EACVI Guidelines):</strong><br>`;
            glsDetails += `• <strong style="color: #10b981;">< 5% change:</strong> Normal variation - Continue treatment<br>`;
            glsDetails += `• <strong style="color: #3b82f6;">5-9.9% change:</strong> Mild change - Monitor closely<br>`;
            glsDetails += `• <strong style="color: #f59e0b;">10-14.9% change:</strong> Warning - Consider intervention<br>`;
            glsDetails += `• <strong style="color: #dc2626;">≥15% change:</strong> SIGNIFICANT CARDIOTOXICITY - Urgent action required</div>`;
            
            glsDetails += `<div class="calc-step"><strong>Step 5 - Absolute GLS Assessment:</strong><br>`;
            glsDetails += `• GLS ≤ -20%: Normal function<br>`;
            glsDetails += `• GLS -18% to -19.9%: Borderline (+5% risk)<br>`;
            glsDetails += `• GLS -16% to -17.9%: Abnormal (+15% risk)<br>`;
            glsDetails += `• GLS > -16% (less negative): Severely abnormal (+30% risk)</div>`;
            
            const glsRiskClass = risks.isGLSCardiotoxicity ? 'high-risk' : glsRelChange >= 10 ? 'medium-risk' : 'low-risk';
            glsDetails += `<div class="calc-result ${glsRiskClass}">`;
            glsDetails += `GLS Assessment: ${glsChangeSig.label}<br>`;
            glsDetails += `Risk Contribution: +${(glsStatus.riskAddition || 0) + (glsChangeSig.riskAddition || 0)}% to cardiotoxicity`;
            if (risks.isGLSCardiotoxicity) {
                glsDetails += `<br><strong style="color: #dc2626;">[ALERT] CARDIOTOXICITY THRESHOLD EXCEEDED</strong>`;
            }
            glsDetails += `</div>`;
            
            let html = '<div class="accordion-container">';
            
            // GLS accordion - PRIMARY CARDIOTOXICITY INDICATOR (first position)
            html += `<div class="accordion-item active" onclick="toggleAccordion(this)">
                <div class="accordion-header" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-bottom-color: #f59e0b;">
                    <div class="accordion-header-left">
                        <div class="accordion-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                        <div>
                            <div class="accordion-title" style="color: #92400e;">Global Longitudinal Strain (GLS) <span style="font-size: 0.65em; background: #dc2626; color: white; padding: 2px 8px; border-radius: 8px; margin-left: 8px;">PRIMARY INDICATOR</span></div>
                            <div class="accordion-subtitle" style="color: #78350f;">Change: ${glsRelChange >= 0 ? '+' : ''}${glsRelChange.toFixed(1)}% | Status: ${glsStatus.label}</div>
                        </div>
                    </div>
                    <span class="accordion-arrow">▼</span>
                </div>
                <div class="accordion-content" style="display: block;">
                    <div class="accordion-body">
                        <p style="margin-bottom: 15px;"><strong>Formula:</strong> Relative Change = ((Current GLS - Baseline GLS) / |Baseline GLS|) × 100</p>
                        ${glsDetails}
                    </div>
                </div>
            </div>`;
            
            // Cardiotoxicity accordion
            html += `<div class="accordion-item" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                    <div class="accordion-header-left">
                        <div class="accordion-icon cardio"></div>
                        <div>
                            <div class="accordion-title">Combined Cardiotoxicity Risk Calculation</div>
                            <div class="accordion-subtitle">Final Risk: ${risks.cardioRisk}% (includes GLS assessment)</div>
                        </div>
                    </div>
                    <span class="accordion-arrow">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <p style="margin-bottom: 15px;"><strong>Formula:</strong> Base Risk + Age + Sex + Diseases + EF + GLS + Cancer Subtype + Vitals</p>
                        ${cardioDetails}
                    </div>
                </div>
            </div>`;
            
            // Neutropenia accordion
            html += `<div class="accordion-item" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                    <div class="accordion-header-left">
                        <div class="accordion-icon neutro"></div>
                        <div>
                            <div class="accordion-title">Neutropenia Risk Calculation</div>
                            <div class="accordion-subtitle">Final Risk: ${risks.neutroRisk}%</div>
                        </div>
                    </div>
                    <span class="accordion-arrow">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <p style="margin-bottom: 15px;"><strong>Formula:</strong> 35% baseline + (Dose/600 × 45%) + Age + Cancer Type + Diseases</p>
                        ${neutroDetails}
                    </div>
                </div>
            </div>`;
            
            // Anemia accordion
            html += `<div class="accordion-item" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                    <div class="accordion-header-left">
                        <div class="accordion-icon anemia"></div>
                        <div>
                            <div class="accordion-title">Anemia Risk Calculation</div>
                            <div class="accordion-subtitle">Final Risk: ${risks.anemiaRisk}%</div>
                        </div>
                    </div>
                    <span class="accordion-arrow">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <p style="margin-bottom: 15px;"><strong>Formula:</strong> 30% baseline + (Dose/600 × 45%) + Sex + Cancer Subtype + Pre-existing Anemia</p>
                        ${anemiaDetails}
                    </div>
                </div>
            </div>`;
            
            // Info accordion
            html += `<div class="accordion-item" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                    <div class="accordion-header-left">
                        <div class="accordion-icon info"></div>
                        <div>
                            <div class="accordion-title">Why These Calculations Matter</div>
                            <div class="accordion-subtitle">Understanding personalized risk assessment</div>
                        </div>
                    </div>
                    <span class="accordion-arrow">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-body">
                        ${infoDetails}
                    </div>
                </div>
            </div>`;
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Toggle accordion function
        function toggleAccordion(element) {
            element.classList.toggle('active');
        }

        // Display session history
        function displaySessionHistory() {
            const container = document.getElementById('sessionHistoryList');
            container.innerHTML = '';
            
            if (!currentPatient || currentPatient.sessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
                        <div style="font-size: 1.5em; margin-bottom: 15px; color: #64748b;">No History</div>
                        <h4 style="color: #475569; margin-bottom: 10px;">No Sessions Taken Yet</h4>
                        <p style="color: #64748b; margin-bottom: 20px;">Start your first treatment session to see the history here.</p>
                        <button onclick="scrollToAddSession()" style="background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s;">
                            Add First Session
                        </button>
                    </div>
                `;
                return;
            }
            
            currentPatient.sessions.forEach((session) => {
                const item = document.createElement('div');
                item.className = 'session-item';
                const date = new Date(session.date).toLocaleDateString();
                const time = new Date(session.date).toLocaleTimeString();
                
                // GLS status for display
                const glsChange = session.risks.glsRelativeChange || 0;
                const glsStatus = session.risks.glsStatus || { label: 'N/A', color: '#64748b' };
                const isGLSCardiotoxicity = session.risks.isGLSCardiotoxicity || false;
                
                item.innerHTML = `
                    <h4>Session ${session.sessionNumber} - ${date} at ${time}</h4>
                    <p><strong>Dose:</strong> ${session.dose} mg/m² | <strong>Cumulative:</strong> ${session.cumulativeDose} mg/m²</p>
                    <p><strong>Vitals:</strong> BP: ${session.vitals.bloodPressure} | HR: ${session.vitals.heartRate} bpm | Temp: ${session.vitals.temperature}°C | EF: ${session.ejectionFraction || 'N/A'}%</p>
                    <p><strong>GLS:</strong> Baseline: ${session.baselineGLS || currentPatient.baselineGLS || -21}% | Current: ${session.currentGLS || currentPatient.currentGLS || -21}% | Change: <span style="color: ${glsChange >= 15 ? '#dc2626' : glsChange >= 10 ? '#f59e0b' : '#10b981'}; font-weight: 600;">${glsChange >= 0 ? '+' : ''}${glsChange.toFixed(1)}%</span> ${isGLSCardiotoxicity ? '<span style="color: #dc2626; font-weight: 700;">[CARDIOTOXICITY]</span>' : ''}</p>
                    <p><strong>Cancer:</strong> ${currentPatient.cancer} (${session.cancerSubtype || currentPatient.cancerSubtype})</p>
                    <p><strong>Risks:</strong> Cardio: ${session.risks.cardioRisk}% | Neutro: ${session.risks.neutroRisk}% | Recovery: ${session.risks.overallScore}</p>
                `;
                container.appendChild(item);
            });
        }
        
        // Scroll to Add Treatment Session button
        function scrollToAddSession() {
            const addSessionBtn = document.querySelector('.btn-add-session');
            if (addSessionBtn) {
                addSessionBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                addSessionBtn.style.animation = 'pulse-highlight 1s ease-in-out 3';
                setTimeout(() => {
                    addSessionBtn.style.animation = '';
                }, 3000);
            }
        }

        // Update charts with clickable functionality
        function updateCharts() {
            updateRiskChart();
            if (currentPatient.sessions.length > 0) {
            updateProgressChart();
            updatePatientJourneyChart();
            }
        }

        // Update risk chart with clickable bars (robust, fast, repeatable clicks)
        function updateRiskChart() {
            const ctx = document.getElementById('riskChart');
            if (!ctx) return;

            const risks = calculateDigitalTwinRisks(currentPatient);

            if (charts.riskChart) {
            // remove previous click handler to avoid multiple handlers stacking
            try { charts.riskChart.canvas.onclick = null; } catch (e) {}
            charts.riskChart.destroy();
            }

            const colors = [
            risks.cardioRisk > 30 ? '#dc2626' : risks.cardioRisk > 15 ? '#f59e0b' : '#10b981',
            risks.neutroRisk > 70 ? '#dc2626' : risks.neutroRisk > 50 ? '#f59e0b' : '#3b82f6',
            risks.anemiaRisk > 60 ? '#dc2626' : risks.anemiaRisk > 40 ? '#f59e0b' : '#8b5cf6',
            risks.nauseaRisk > 85 ? '#dc2626' : risks.nauseaRisk > 70 ? '#f59e0b' : '#10b981',
            risks.fatigueRisk > 70 ? '#dc2626' : risks.fatigueRisk > 50 ? '#f59e0b' : '#ec4899'
            ];

            charts.riskChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Cardiotoxicity', 'Neutropenia', 'Anemia', 'Nausea', 'Fatigue'],
                datasets: [{
                label: 'Risk (%)',
                data: [risks.cardioRisk, risks.neutroRisk, risks.anemiaRisk, risks.nauseaRisk, risks.fatigueRisk],
                backgroundColor: colors,
                borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                y: { beginAtZero: true, max: 100 }
                },
                plugins: { legend: { display: false } },
                // keep lightweight internal click (fallback) but primary handling uses canvas listener below
                onClick: undefined
            }
            });

            // Attach a single, robust click handler to the chart canvas.
            // Use getElementsAtEventForMode to reliably detect the bar under the pointer.
            charts.riskChart.canvas.onclick = function (evt) {
            try {
                const points = charts.riskChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                if (!points || points.length === 0) return;

                const index = points[0].index;
                const riskTypes = ['cardiotoxicity', 'neutropenia', 'anemia', 'nausea', 'fatigue'];
                selectedRiskType = riskTypes[index];

                // Recompute fresh risks (avoid stale closure) and show details asynchronously
                const freshRisks = calculateDigitalTwinRisks(currentPatient);
                // Use requestAnimationFrame to keep UI responsive for rapid clicks
                requestAnimationFrame(() => showRiskDetails(selectedRiskType, freshRisks));
            } catch (err) {
                console.error('Risk chart click handler error:', err);
            }
            };
        }

        // Show risk details when bar is clicked - FIXED VERSION (fast, repeatable)
        function showRiskDetails(riskType, risks) {
            const panel = document.getElementById('riskDetailPanel');
            panel.classList.add('active');

            // Build HTML in a local variable and assign once for better performance
            let html = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h4 style="margin:0;">${riskType.charAt(0).toUpperCase() + riskType.slice(1)} Risk Details</h4>
                    <button onclick="document.getElementById('riskDetailPanel').classList.remove('active')" style="background:#efefef;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Close</button>
                </div>`;

            if (riskType === 'cardiotoxicity') {
            html += `<p><strong>Current Risk: ${risks.cardioRisk}%</strong></p>`;
            html += '<p><strong>Calculation Factors:</strong></p>';
            if (risks.cardioModifiers && risks.cardioModifiers.length > 0) {
                risks.cardioModifiers.forEach(mod => {
                html += `<div class="calculation-step">${mod}</div>`;
                });
            } else {
                html += '<div class="calculation-step">Baseline risk based on cumulative dose</div>';
            }
            html += '<p><strong>Clinical Implications:</strong></p>';
            if (risks.cardioRisk > 30) {
                html += '<div class="calculation-step" style="border-left-color: #dc2626;">HIGH RISK: Requires immediate cardioprotective intervention</div>';
            } else if (risks.cardioRisk > 15) {
                html += '<div class="calculation-step" style="border-left-color: #f59e0b;">MODERATE RISK: Monitor closely and consider prophylaxis</div>';
            } else {
                html += '<div class="calculation-step" style="border-left-color: #10b981;">LOW RISK: Continue standard monitoring</div>';
            }
            } 
            else if (riskType === 'neutropenia') {
            html += `<p><strong>Current Risk: ${risks.neutroRisk}%</strong></p>`;
            html += '<p><strong>Calculation Factors:</strong></p>';
            if (risks.neutroModifiers && risks.neutroModifiers.length > 0) {
                risks.neutroModifiers.forEach(mod => {
                html += `<div class="calculation-step">${mod}</div>`;
                });
            } else {
                html += '<div class="calculation-step">Baseline risk: 35%</div>';
                html += `<div class="calculation-step">Dose contribution: (${currentPatient.cumulativeDose}/600) × 45% = ${Math.round((currentPatient.cumulativeDose/600)*45)}%</div>`;
                if (currentPatient.age > 65) {
                html += `<div class="calculation-step">Age factor (${currentPatient.age}): +12%</div>`;
                }
                if (currentPatient.cancer === 'leukemia') {
                html += '<div class="calculation-step">Leukemia factor: +18%</div>';
                }
            }
            html += '<p><strong>Clinical Implications:</strong></p>';
            if (risks.neutroRisk > 60) {
                html += '<div class="calculation-step" style="border-left-color: #dc2626;">HIGH RISK: G-CSF prophylaxis recommended</div>';
            } else if (risks.neutroRisk > 40) {
                html += '<div class="calculation-step" style="border-left-color: #f59e0b;">MODERATE RISK: Monitor CBC closely</div>';
            } else {
                html += '<div class="calculation-step" style="border-left-color: #10b981;">LOW RISK: Standard monitoring</div>';
            }
            }
            else if (riskType === 'anemia') {
            html += `<p><strong>Current Risk: ${risks.anemiaRisk}%</strong></p>`;
            html += '<p><strong>Calculation Factors:</strong></p>';
            html += `<div class="calculation-step">Baseline risk: 30%</div>`;
            html += `<div class="calculation-step">Dose contribution: (${currentPatient.cumulativeDose}/600) × 45% = ${Math.round((currentPatient.cumulativeDose/600)*45)}%</div>`;
            if (currentPatient.sex === 'female') {
                html += '<div class="calculation-step">Female sex: +8%</div>';
            }
            if (currentPatient.cancer === 'leukemia') {
                html += '<div class="calculation-step">Leukemia: +15%</div>';
                if (currentPatient.cancerSubtype === 'AML') {
                html += '<div class="calculation-step">AML subtype: +8%</div>';
                }
            }
            if (currentPatient.chronicDiseases.includes('anemia')) {
                html += '<div class="calculation-step">Pre-existing anemia: +25%</div>';
            }
            html += '<p><strong>Clinical Implications:</strong></p>';
            if (risks.anemiaRisk > 70 || currentPatient.chronicDiseases.includes('anemia')) {
                html += '<div class="calculation-step" style="border-left-color: #dc2626;">HIGH RISK: Monitor hemoglobin weekly, consider ESA therapy</div>';
            } else if (risks.anemiaRisk > 50) {
                html += '<div class="calculation-step" style="border-left-color: #f59e0b;">MODERATE RISK: Monitor hemoglobin bi-weekly</div>';
            } else {
                html += '<div class="calculation-step" style="border-left-color: #10b981;">LOW RISK: Standard monitoring</div>';
            }
            }
            else if (riskType === 'nausea') {
            html += `<p><strong>Current Risk: ${risks.nauseaRisk}%</strong></p>`;
            html += '<p><strong>Calculation Factors:</strong></p>';
            html += '<div class="calculation-step">Baseline chemotherapy-induced nausea: 82%</div>';
            if (currentPatient.sex === 'female') {
                html += '<div class="calculation-step">Female sex: +10% (hormonal factors increase susceptibility)</div>';
            }
            html += '<p><strong>Clinical Implications:</strong></p>';
            html += '<div class="calculation-step" style="border-left-color: #f59e0b;">STANDARD PROPHYLAXIS: Administer 5-HT3 antagonist + dexamethasone pre-treatment</div>';
            }
            else if (riskType === 'fatigue') {
            html += `<p><strong>Current Risk: ${risks.fatigueRisk}%</strong></p>`;
            html += '<p><strong>Calculation Factors:</strong></p>';
            html += `<div class="calculation-step">Baseline fatigue: 55%</div>`;
            html += `<div class="calculation-step">Dose contribution: (${currentPatient.cumulativeDose}/600) × 35% = ${Math.round((currentPatient.cumulativeDose/600)*35)}%</div>`;
            if (currentPatient.age > 60) {
                html += `<div class="calculation-step">Age factor (${currentPatient.age}): +10%</div>`;
            }
            html += '<p><strong>Clinical Implications:</strong></p>';
            if (risks.fatigueRisk > 70) {
                html += '<div class="calculation-step" style="border-left-color: #dc2626;">HIGH RISK: Implement fatigue management program, consider dose modification</div>';
            } else if (risks.fatigueRisk > 50) {
                html += '<div class="calculation-step" style="border-left-color: #f59e0b;">MODERATE RISK: Educate on energy conservation techniques</div>';
            } else {
                html += '<div class="calculation-step" style="border-left-color: #10b981;">LOW RISK: Standard fatigue monitoring</div>';
            }
            }

            panel.innerHTML = html;
            // Ensure panel scroll resets for quick subsequent clicks
            panel.scrollTop = 0;
        }

        // Update progress chart
        function updateProgressChart() {
            const ctx = document.getElementById('progressChart');
            if (!ctx || currentPatient.sessions.length === 0) return;

            const progressData = currentPatient.sessions.map((session, idx) => ({
            session: `S${idx + 1}`,
            cardio: session.risks.cardioRisk,
            neutro: session.risks.neutroRisk,
            score: session.risks.overallScore,
            dose: session.cumulativeDose
            }));

            if (charts.progressChart) charts.progressChart.destroy();

            charts.progressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: progressData.map(d => d.session),
                datasets: [
                {
                    label: 'Recovery Score',
                    data: progressData.map(d => d.score),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    yAxisID: 'y'
                },
                {
                    label: 'Cardiotoxicity',
                    data: progressData.map(d => d.cardio),
                    borderColor: '#ef4444',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Neutropenia',
                    data: progressData.map(d => d.neutro),
                    borderColor: '#3b82f6',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Cumulative Dose',
                    data: progressData.map(d => d.dose),
                    borderColor: '#8b5cf6',
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                y: { position: 'left', max: 100 },
                y1: { position: 'right', grid: { drawOnChartArea: false } }
                }
            }
            });
        }
        // Update patient journey chart
        function updatePatientJourneyChart() {
            const ctx = document.getElementById('patientJourneyChart');
            if (!ctx || currentPatient.sessions.length === 0) return;
            
            const journeyData = currentPatient.sessions.map((session, idx) => ({
                session: `S${idx + 1}`,
                overall: session.risks.overallScore
            }));
            
            if (charts.patientJourneyChart) charts.patientJourneyChart.destroy();
            
            charts.patientJourneyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: journeyData.map(d => d.session),
                    datasets: [{
                        label: 'Health Score',
                        data: journeyData.map(d => d.overall),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        // Update patient view
        function updatePatientView(risks) {
            const noData = document.getElementById('noDataMessage');
            const dataContent = document.getElementById('patientDataContent');
            
            if (currentPatient.sessions.length === 0) {
                noData.style.display = 'block';
                dataContent.style.display = 'none';
                return;
            }
            
            noData.style.display = 'none';
            dataContent.style.display = 'block';
            
            updateRecoveryCircle(risks.overallScore);
            
            const heartScore = 100 - risks.cardioRisk;
            document.getElementById('patientHeartScore').textContent = Math.round(heartScore);
            document.getElementById('heartBar').style.width = heartScore + '%';
            
            const bloodScore = 100 - risks.neutroRisk;
            document.getElementById('patientBloodScore').textContent = Math.round(bloodScore);
            document.getElementById('bloodBar').style.width = bloodScore + '%';
            
            const energyScore = 100 - risks.fatigueRisk;
            document.getElementById('patientEnergyScore').textContent = Math.round(energyScore);
            document.getElementById('energyBar').style.width = energyScore + '%';
            
            updatePatientAdvice(risks);
        }

        // Update recovery circle
        function updateRecoveryCircle(score) {
            const svg = document.getElementById('recoveryCircleSVG');
            const numberDisplay = document.getElementById('recoveryScoreNumber');
            const messageDisplay = document.getElementById('recoveryMessage');
            
            const radius = 85;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score / 100) * circumference;
            
            let color = score > 70 ? '#10b981' : score > 40 ? '#f59e0b' : '#ef4444';
            
            svg.innerHTML = `
                <circle cx="100" cy="100" r="85" fill="none" stroke="#e5e7eb" stroke-width="12"/>
                <circle cx="100" cy="100" r="85" fill="none" stroke="${color}" stroke-width="12"
                        stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                        transform="rotate(-90 100 100)" stroke-linecap="round"/>
            `;
            
            numberDisplay.textContent = score;
            
            if (score > 70) {
                messageDisplay.innerHTML = '<strong>Great Recovery!</strong> Your body is handling treatment well.';
            } else if (score > 40) {
                messageDisplay.innerHTML = '<strong>Moderate Strain.</strong> Rest and follow your care plan.';
            } else {
                messageDisplay.innerHTML = '<strong>High Strain.</strong> Contact your healthcare team today.';
            }
        }

        // Update patient advice
        function updatePatientAdvice(risks) {
            const adviceSection = document.getElementById('patientAdviceSection');
            
            let html = '<h3 style="color: #0066cc;">Your Personalized Care Guide</h3>';
            html += '<p style="color: #666; margin-bottom: 20px;">Based on your current treatment</p>';
            
            const systolic = parseInt(currentPatient.vitals.bloodPressure.split('/')[0]);
            
            if (systolic > 140 || currentPatient.vitals.heartRate > 100) {
                html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">';
                html += '<h4 style="color: #856404; margin-bottom: 10px;">Health Status Alert</h4>';
                if (systolic > 140) {
                    html += `<p>Blood pressure (${currentPatient.vitals.bloodPressure}) is elevated. Reduce salt and contact your doctor.</p>`;
                }
                html += '</div>';
            }
            
            if (risks.cardioRisk > 20) {
                html += '<div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ef4444;">';
                html += '<h4 style="color: #991b1b; margin-bottom: 10px;">Heart Care</h4>';
                html += `<p>Heart risk: ${risks.cardioRisk}%</p>`;
                html += '<ul style="margin-left: 20px; color: #7f1d1d;">';
                html += '<li>Eat heart-healthy foods</li>';
                html += '<li>Gentle 10-minute walks</li>';
                html += '<li>Avoid smoking and alcohol</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            if (risks.neutroRisk > 60) {
                html += '<div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">';
                html += '<h4 style="color: #1e40af; margin-bottom: 10px;">Infection Prevention</h4>';
                html += `<p>Infection risk: ${risks.neutroRisk}%</p>`;
                html += '<ul style="margin-left: 20px; color: #1e3a8a;">';
                html += '<li>Wash hands frequently</li>';
                html += '<li>Avoid crowds</li>';
                html += '<li>Cook food thoroughly</li>';
                html += '<li>Call doctor if fever ≥38°C</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            // Cancer subtype-specific advice
            if (currentPatient.cancer === 'leukemia' && currentPatient.cancerSubtype === 'AML') {
                html += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #d97706;">';
                html += '<h4 style="color: #92400e; margin-bottom: 10px;">AML-Specific Care</h4>';
                html += '<ul style="margin-left: 20px; color: #92400e;">';
                html += '<li>Report any breathing difficulties immediately</li>';
                html += '<li>Watch for signs of tumor lysis (nausea, muscle cramps)</li>';
                html += '<li>Take prescribed antifungal medications as directed</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            if (currentPatient.cancer === 'lymphoma' && currentPatient.cancerSubtype === 'HL') {
                html += '<div style="background: #fce7f3; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #db2777;">';
                html += '<h4 style="color: #9d174d; margin-bottom: 10px;">Hodgkin Lymphoma Care</h4>';
                html += '<ul style="margin-left: 20px; color: #9d174d;">';
                html += '<li>Report any cough or breathing changes</li>';
                html += '<li>Discuss fertility preservation options with your doctor</li>';
                html += '<li>Regular thyroid function monitoring recommended</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            html += '<div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">';
            html += '<h4 style="color: #991b1b; margin-bottom: 10px;">Call Doctor If:</h4>';
            html += '<ul style="margin-left: 20px; color: #7f1d1d; font-weight: 500;">';
            html += '<li>Fever ≥38°C (100.4°F)</li>';
            html += '<li>Chest pain or breathing difficulty</li>';
            html += '<li>Unusual bleeding</li>';
            html += '<li>Severe dizziness</li>';
            html += '</ul>';
            html += '</div>';
            
            adviceSection.innerHTML = html;
        }

        // Switch view function
        function switchView(mode) {
            currentView = mode;
            
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const doctorView = document.getElementById('doctorView');
            const patientView = document.getElementById('patientView');
            
            if (mode === 'patient') {
                doctorView.style.display = 'none';
                patientView.style.display = 'block';
                if (currentPatient && currentPatient.sessions.length > 0) {
                    const latestRisks = currentPatient.sessions[currentPatient.sessions.length - 1].risks;
                    updatePatientView(latestRisks);
                }
            } else {
                doctorView.style.display = 'block';
                patientView.style.display = 'none';
            }
        }

        // Switch tab function
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Export patient report
        function exportPatientReport() {
            if (!currentPatient) return;
            
            let report = `CHEMOTHERAPY DIGITAL TWIN REPORT\n${'='.repeat(60)}\n\n`;
            report += `Patient: ${currentPatient.id}\n`;
            report += `Date: ${new Date().toLocaleString()}\n\n`;
            report += `Age: ${currentPatient.age} | Sex: ${currentPatient.sex} | Cancer: ${currentPatient.cancer} | Subtype: ${currentPatient.cancerSubtype}\n`;
            report += `Chronic Diseases: ${currentPatient.chronicDiseases.join(', ') || 'None'}\n`;
            report += `Ejection Fraction: ${currentPatient.ejectionFraction}%\n\n`;
            report += `Cumulative Dose: ${currentPatient.cumulativeDose} mg/m²\n`;
            report += `Total Sessions: ${currentPatient.sessions.length}\n\n`;
            
            if (currentPatient.sessions.length > 0) {
                const latest = currentPatient.sessions[currentPatient.sessions.length - 1];
                report += `LATEST RISK ASSESSMENT:\n`;
                report += `Cardiotoxicity: ${latest.risks.cardioRisk}%\n`;
                report += `Neutropenia: ${latest.risks.neutroRisk}%\n`;
                report += `Anemia: ${latest.risks.anemiaRisk}%\n`;
                report += `Recovery Score: ${latest.risks.overallScore}\n\n`;
                
                report += `SESSION HISTORY:\n`;
                currentPatient.sessions.forEach(s => {
                    report += `\nSession ${s.sessionNumber} - ${new Date(s.date).toLocaleString()}\n`;
                    report += `  Dose: ${s.dose} mg/m² | Cumulative: ${s.cumulativeDose} mg/m²\n`;
                    report += `  Vitals: BP ${s.vitals.bloodPressure} | HR ${s.vitals.heartRate} | Temp ${s.vitals.temperature}°C | EF ${s.ejectionFraction || 'N/A'}%\n`;
                    report += `  Cancer: ${currentPatient.cancer} (${s.cancerSubtype || currentPatient.cancerSubtype})\n`;
                    report += `  Risks: Cardio ${s.risks.cardioRisk}% | Neutro ${s.risks.neutroRisk}% | Recovery ${s.risks.overallScore}\n`;
                });
            }
            
            report += `\n${'='.repeat(60)}\n`;
            report += `ChemoTwin Clinical Platform - Evidence-Based Digital Twins\n`;
            report += `Developed by Bakr Waheed\n`;
            report += `Contact: bakrwaheed0@gmail.com\n`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ChemoTwin_${currentPatient.id}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // FIXED BLUETOOTH CONNECTION FUNCTIONS
        async function connectBluetoothDevice() {
            const connectBtn = document.getElementById('connectBtn');
            
            // Check if Bluetooth is available
            if (!navigator.bluetooth) {
                alert('Bluetooth is not supported in this browser. Using simulated data instead.');
                startSimulatedVitals();
                return;
            }
            
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                return;
            }
            
            try {
                connectBtn.textContent = 'Searching...';
                
                // Request any Bluetooth device to improve scanning
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['heart_rate', 'battery_service', 'device_information', 'generic_access']
                });
                
                connectBtn.textContent = 'Connecting...';
                
                const server = await bluetoothDevice.gatt.connect();
                
                // Try to get heart rate service if available
                try {
                    const service = await server.getPrimaryService('heart_rate');
                    heartRateCharacteristic = await service.getCharacteristic('heart_rate_measurement');
                    
                    await heartRateCharacteristic.startNotifications();
                    heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChange);
                } catch (hrError) {
                    console.log('Heart rate service not available, using simulated data');
                    // Simulate heart rate data if service not available
                    startSimulatedVitals();
                }
                
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                document.getElementById('deviceStatusDot').classList.add('connected');
                document.getElementById('deviceStatusText').textContent = `Connected: ${bluetoothDevice.name || 'Device'}`;
                document.getElementById('vitalsDisplay').style.display = 'block';
                connectBtn.textContent = 'Disconnect';
                connectBtn.classList.add('btn-disconnect');
                
            } catch (error) {
                console.error('Bluetooth connection error:', error);
                if (error.name === 'NotFoundError') {
                    alert('No Bluetooth device selected. Using simulated data instead.');
                    startSimulatedVitals();
                } else {
                    alert('Failed to connect to device. Using simulated data instead. Error: ' + error.message);
                    startSimulatedVitals();
                }
                connectBtn.textContent = 'Connect Device';
            }
        }
        
        // Simulate vitals if real device doesn't support heart rate service
        let simulatedInterval = null;
        function startSimulatedVitals() {
            if (simulatedInterval) clearInterval(simulatedInterval);
            
            // Update UI to show simulated connection
            document.getElementById('deviceStatusDot').classList.add('connected');
            document.getElementById('deviceStatusText').textContent = 'Connected: Simulated Device';
            document.getElementById('vitalsDisplay').style.display = 'block';
            document.getElementById('connectBtn').textContent = 'Disconnect';
            document.getElementById('connectBtn').classList.add('btn-disconnect');
            
            simulatedInterval = setInterval(() => {
                if (currentPatient) {
                    // Simulate realistic heart rate variations
                    const baseHR = parseInt(currentPatient.vitals.heartRate) || 75;
                    const variation = Math.floor(Math.random() * 10) - 5;
                    const newHR = Math.max(60, Math.min(100, baseHR + variation));
                    
                    currentPatient.vitals.heartRate = newHR;
                    document.getElementById('heartRate').value = newHR;
                    updateSidebarVitals();
                    
                    // Simulate slight BP variations
                    const bpParts = currentPatient.vitals.bloodPressure.split('/');
                    const systolic = parseInt(bpParts[0]) + (Math.random() > 0.5 ? 1 : -1);
                    const diastolic = parseInt(bpParts[1]) + (Math.random() > 0.5 ? 1 : -1);
                    currentPatient.vitals.bloodPressure = `${Math.max(90, systolic)}/${Math.max(60, diastolic)}`;
                    document.getElementById('bloodPressure').value = currentPatient.vitals.bloodPressure;
                    
                    // Simulate slight temperature variations
                    const baseTemp = parseFloat(currentPatient.vitals.temperature) || 37.0;
                    const tempVariation = (Math.random() * 0.4) - 0.2;
                    currentPatient.vitals.temperature = (baseTemp + tempVariation).toFixed(1);
                    document.getElementById('temperature').value = currentPatient.vitals.temperature;
                    
                    savePatientData();
                    
                    if (currentPatient.sessions.length > 0) {
                        runSimulation();
                    }
                }
            }, 3000);
        }

        function handleHeartRateChange(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            
            if (currentPatient) {
                currentPatient.vitals.heartRate = heartRate;
                document.getElementById('heartRate').value = heartRate;
                updateSidebarVitals();
                savePatientData();
                
                if (currentPatient.sessions.length > 0) {
                    runSimulation();
                }
            }
        }

        function onDisconnected() {
            document.getElementById('deviceStatusDot').classList.remove('connected');
            document.getElementById('deviceStatusText').textContent = 'Device Disconnected';
            document.getElementById('vitalsDisplay').style.display = 'none';
            document.getElementById('connectBtn').textContent = 'Connect Device';
            document.getElementById('connectBtn').classList.remove('btn-disconnect');
            
            if (simulatedInterval) {
                clearInterval(simulatedInterval);
                simulatedInterval = null;
            }
        }

        // Particle animation
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
                particle.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(particle);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Check if EmailJS is properly initialized
            console.log('🔧 Checking EmailJS initialization...');
            if (typeof emailjs !== 'undefined') {
                console.log('EmailJS library loaded successfully!');
                console.log('📧 EmailJS Configuration:');
                console.log('   - Service ID: service_e8dcl0l');
                console.log('   - Template ID: template_pxtj7kr');
                console.log('   - Public Key: zw5gaDMv_koqacN8M');
                console.log('');
                console.log('💡 Tip: Check the browser console for email sending status');
                console.log('   - Success means email sent successfully');
                console.log('   - Error means email failed (check error details)');
            } else {
                console.error('EmailJS library NOT loaded!');
                console.error('   This could be due to:');
                console.error('   1. Internet connection issues');
                console.error('   2. CDN blocked by firewall/adblocker');
                console.error('   3. Script loading timeout');
            }
            console.log('');

            createParticles();
            trackVisitor();
        });
    </script>
</body>
</html>
