<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemoTwin RAG Simulator: Digital Twins for Chemotherapy Effects</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Global resets and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e6f0fa 0%, #d0e4ff 100%);
            z-index: -2;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 102, 204, 0.2);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); }
            100% { transform: translateY(-100vh) translateX(100px); }
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 102, 204, 0.1);
        }

        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #0066cc, #3399ff, #0066cc);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
            margin-bottom: 10px;
            text-align: center;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .subtitle {
            color: #555;
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .view-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            background: #e2e8f0;
            color: #64748b;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #0066cc, #3399ff);
            color: white;
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.3);
        }

        .view-btn:hover {
            transform: translateY(-2px);
        }

        .patient-id-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 102, 204, 0.1);
        }

        .patient-id-section h2 {
            color: #0066cc;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .id-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .patient-id-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .patient-id-input:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 20px rgba(0, 102, 204, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0066cc, #3399ff);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
        }

        .input-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 20px;
            padding: 25px;
            height: fit-content;
            display: none;
        }

        .input-panel.active {
            display: block;
        }

        .input-panel h2 {
            color: #0066cc;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        #currentPatientId {
            color: #10b981;
            font-weight: bold;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 102, 204, 0.1);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            color: #0066cc;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            background: rgba(230, 240, 250, 0.5);
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 8px;
            color: #333;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #0066cc;
            background: rgba(230, 240, 250, 0.8);
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
        }

        .dose-display {
            background: rgba(230, 240, 250, 0.5);
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .dose-display label {
            display: block;
            color: #0066cc;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .dose-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .dose-progress {
            width: 100%;
            height: 10px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .dose-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .dose-display small {
            color: #666;
            font-size: 0.85em;
        }

        .btn-add-session {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-session:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .session-count {
            margin-top: 15px;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
        }

        .session-count span {
            color: #10b981;
            font-weight: bold;
            font-size: 1.2em;
        }

        .results-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 20px;
            padding: 25px;
            min-height: 600px;
            display: none;
        }

        .results-panel.active {
            display: block;
        }

        .results-panel h2 {
            color: #0066cc;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 102, 204, 0.2);
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-weight: 500;
            font-size: 0.95em;
        }

        .tab:hover {
            color: #0066cc;
        }

        .tab.active {
            color: #0066cc;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0066cc, #3399ff);
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .alert h4 {
            color: #991b1b;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .alert p {
            color: #7f1d1d;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: rgba(230, 240, 250, 0.6);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .metric-card:hover {
            background: rgba(230, 240, 250, 0.9);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 102, 204, 0.2);
        }

        .metric-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #0066cc, #3399ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }

        .metric-label {
            color: #555;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .study-card {
            background: white;
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .study-card h5 {
            color: #0066cc;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .study-card p {
            color: #555;
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #0066cc;
            margin-bottom: 15px;
        }

        canvas {
            max-width: 100%;
            height: 300px !important;
        }

        .session-item {
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(230, 240, 250, 0.4);
            border-radius: 8px;
        }

        .session-item h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }

        .session-item p {
            color: #555;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .no-data-message {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .no-data-message .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .recovery-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 20px;
            color: white;
            margin-bottom: 25px;
        }

        .recovery-circle {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .recovery-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: white;
        }

        .patient-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .patient-metric-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .patient-metric-card.heart {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .patient-metric-card.blood {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .patient-metric-card.energy {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
        }

        .patient-metric-card .metric-title {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .heart .metric-bar-fill {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .blood .metric-bar-fill {
            background: linear-gradient(90deg, #2563eb, #3b82f6);
        }

        .energy .metric-bar-fill {
            background: linear-gradient(90deg, #ca8a04, #eab308);
        }

        .patient-advice {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>
    
    <div class="main-container">
        <header class="header">
            <h1>🧬 ChemoTwin Simulator</h1>
            <p class="subtitle">Evidence-Based Digital Twins for Chemotherapy Effects with RAG-Powered Insights</p>
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('doctor')">👨‍⚕️ Doctor View</button>
                <button class="view-btn" onclick="switchView('patient')">👤 Patient View</button>
            </div>
        </header>
        
        <div class="patient-id-section">
            <h2>Patient Identification & Management</h2>
            <div class="id-controls">
                <input type="text" id="patientId" placeholder="Enter Patient ID (e.g., PT-2025-001)" class="patient-id-input">
                <button onclick="loadPatient()" class="btn btn-primary">Load Patient</button>
                <button onclick="generateVirtualPatient()" class="btn btn-success">Generate Virtual Patient</button>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="input-panel" id="patientForm">
                <h2>Patient Profile - <span id="currentPatientId">No Patient Loaded</span></h2>
                
                <div class="form-section">
                    <h3>Demographics</h3>
                    <div class="input-group">
                        <label>Age (years)</label>
                        <input type="number" id="age" min="1" max="100" value="45" oninput="updatePatientRealtime()">
                    </div>
                    
                    <div class="input-group">
                        <label>Sex</label>
                        <select id="sex" onchange="updatePatientRealtime()">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Cancer Type</label>
                        <select id="cancer" onchange="updatePatientRealtime()">
                            <option value="leukemia">Leukemia</option>
                            <option value="lymphoma">Lymphoma</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Chronic Diseases (Ctrl+Click for multiple)</label>
                        <select id="chronicDiseases" multiple onchange="updatePatientRealtime()">
                            <option value="diabetes">Diabetes</option>
                            <option value="hypertension">Hypertension</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Current Vitals</h3>
                    <div class="input-group">
                        <label>Temperature (°C)</label>
                        <input type="number" id="temperature" step="0.1" min="35" max="42" value="37.0" oninput="updatePatientRealtime()">
                    </div>
                    
                    <div class="input-group">
                        <label>Blood Pressure (mmHg)</label>
                        <input type="text" id="bloodPressure" placeholder="120/80" value="120/80" oninput="updatePatientRealtime()">
                    </div>
                    
                    <div class="input-group">
                        <label>Heart Rate (bpm)</label>
                        <input type="number" id="heartRate" min="40" max="200" value="75" oninput="updatePatientRealtime()">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Treatment Information</h3>
                    <div class="dose-display">
                        <label>Cumulative Dose</label>
                        <div class="dose-value" id="cumulativeDoseDisplay">0 mg/m²</div>
                        <div class="dose-progress">
                            <div class="dose-progress-bar" id="doseProgressBar" style="width: 0%"></div>
                        </div>
                        <small>Maximum recommended: 550 mg/m²</small>
                    </div>
                    
                    <button class="btn-add-session" onclick="addTreatmentSession()">
                        ➕ Add Treatment Session (60 mg/m²)
                    </button>
                </div>
                
                <div class="session-count">
                    <strong>Total Sessions:</strong> <span id="sessionCount">0</span>
                </div>
            </div>
            
            <div class="results-panel" id="resultsArea">
                <h2>Analysis Results</h2>
                
                <div id="doctorView">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('overview')">Overview</button>
                        <button class="tab" onclick="switchTab('rag-insights')">RAG Insights</button>
                        <button class="tab" onclick="switchTab('history')">Patient History</button>
                    </div>
                    
                    <div id="overview" class="tab-content active">
                        <div id="clinicalAlerts"></div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-icon">❤️</div>
                                <div class="metric-value" id="cardioRisk">--</div>
                                <div class="metric-label">Cardiotoxicity Risk (%)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon">🩸</div>
                                <div class="metric-value" id="neutroRisk">--</div>
                                <div class="metric-label">Neutropenia Risk (%)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon">🔴</div>
                                <div class="metric-value" id="anemiaRisk">--</div>
                                <div class="metric-label">Anemia Risk (%)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon">⭐</div>
                                <div class="metric-value" id="qualityScore">--</div>
                                <div class="metric-label">Recovery Score</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>Risk Distribution</h3>
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="rag-insights" class="tab-content">
                        <h3>Evidence-Based Clinical Insights</h3>
                        <div id="ragStudiesContainer"></div>
                    </div>
                    
                    <div id="history" class="tab-content">
                        <h3>Treatment History & Progress</h3>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div id="sessionHistoryList"></div>
                    </div>
                </div>
                
                <div id="patientView" style="display: none;">
                    <div id="noDataMessage" class="no-data-message">
                        <div class="icon">📊</div>
                        <p>Add your first treatment session to see your health journey</p>
                    </div>
                    
                    <div id="patientDataContent" style="display: none;">
                        <div class="recovery-section">
                            <h3>Your Recovery Score</h3>
                            <div class="recovery-circle">
                                <svg width="200" height="200" id="recoveryCircleSVG"></svg>
                                <div class="recovery-number" id="recoveryScoreNumber">--</div>
                            </div>
                            <p class="recovery-message" id="recoveryMessage"></p>
                        </div>
                        
                        <div class="patient-metrics-grid">
                            <div class="patient-metric-card heart">
                                <div class="metric-icon">❤️</div>
                                <div class="metric-title">Heart Health</div>
                                <div class="metric-value" id="patientHeartScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="heartBar"></div>
                                </div>
                            </div>
                            
                            <div class="patient-metric-card blood">
                                <div class="metric-icon">🩸</div>
                                <div class="metric-title">Blood Health</div>
                                <div class="metric-value" id="patientBloodScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="bloodBar"></div>
                                </div>
                            </div>
                            
                            <div class="patient-metric-card energy">
                                <div class="metric-icon">⚡</div>
                                <div class="metric-title">Energy Level</div>
                                <div class="metric-value" id="patientEnergyScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="energyBar"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>Your Health Journey</h3>
                            <canvas id="patientJourneyChart"></canvas>
                        </div>
                        
                        <div class="patient-advice" id="patientAdviceSection"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let currentPatient = null;
        let patientDatabase = {};
        let currentView = 'doctor';
        let charts = {};

        // RAG Knowledge Base
        const ragKnowledge = {
            cardiotoxicity: {
                studies: [
                    {
                        title: "Lipshultz et al. (1995) - Doxorubicin Cardiotoxicity in Children",
                        findings: "Cumulative doses exceeding 550 mg/m² resulted in 36% cardiotoxicity risk. Subclinical cardiac changes detected via echocardiography at doses as low as 200 mg/m².",
                        dosage: 550,
                        risk: 36
                    },
                    {
                        title: "Swain et al. (2003) - Cardioprotection with Dexrazoxane",
                        findings: "Risk of cardiotoxicity increases exponentially above 450 mg/m². Dexrazoxane reduces cardiotoxicity risk by approximately 50% without compromising antitumor efficacy.",
                        dosage: 450,
                        risk: 18
                    }
                ],
                management: "Dexrazoxane cardioprotection, monitor ECHO/MUGA scans, ACE inhibitors for prevention."
            },
            hematotoxicity: {
                studies: [
                    {
                        title: "Crawford et al. (2004) - Neutropenia and G-CSF",
                        findings: "Grade 3-4 neutropenia occurs in 60-80% of patients. Prophylactic G-CSF reduces febrile neutropenia by 46%.",
                        risk: 60
                    }
                ],
                management: "G-CSF support, monitor CBC, prophylactic antibiotics if ANC <1000/μL."
            }
        };

        // Calculate risks
        function calculateRisks(patient) {
            const dose = patient.cumulativeDose;
            const age = patient.age;
            const sex = patient.sex;
            
            let cardioRisk = 0;
            if (dose > 550) cardioRisk = 36;
            else if (dose > 450) cardioRisk = 18;
            else if (dose > 300) cardioRisk = 8;
            else if (dose > 200) cardioRisk = 3;
            else cardioRisk = 1;
            
            if (age < 18 || age > 65) cardioRisk += 6;
            if (sex === 'female') cardioRisk += 3;
            if (patient.chronicDiseases.includes('diabetes')) cardioRisk += 10;
            if (patient.chronicDiseases.includes('hypertension')) cardioRisk += 8;
            
            const systolic = parseInt(patient.vitals.bloodPressure.split('/')[0]);
            if (systolic > 140) cardioRisk += 5;
            if (patient.vitals.heartRate > 100) cardioRisk += 4;
            
            let neutroRisk = 40 + (dose / 600 * 40);
            if (age > 65) neutroRisk += 10;
            
            let anemiaRisk = 35 + (dose / 600 * 40);
            let nauseaRisk = 85;
            let fatigueRisk = 60 + (dose / 600 * 30);
            
            const overallScore = Math.round(100 - ((cardioRisk + neutroRisk + fatigueRisk) / 3));
            
            return {
                cardioRisk: Math.min(100, Math.round(cardioRisk)),
                neutroRisk: Math.min(100, Math.round(neutroRisk)),
                anemiaRisk: Math.min(100, Math.round(anemiaRisk)),
                nauseaRisk: Math.min(100, Math.round(nauseaRisk)),
                fatigueRisk: Math.min(100, Math.round(fatigueRisk)),
                overallScore: Math.max(0, overallScore)
            };
        }

        // Initialize patient
        function initializePatient(id) {
            return {
                id: id,
                age: 45,
                sex: 'male',
                cancer: 'lymphoma',
                chronicDiseases: [],
                vitals: {
                    temperature: 37.0,
                    bloodPressure: '120/80',
                    heartRate: 75
                },
                cumulativeDose: 0,
                sessions: []
            };
        }

        function loadPatient() {
            const patientId = document.getElementById('patientId').value.trim();
            
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }
            
            if (patientDatabase[patientId]) {
                currentPatient = patientDatabase[patientId];
                alert(`Patient ${patientId} loaded! Sessions: ${currentPatient.sessions.length}`);
            } else {
                currentPatient = initializePatient(patientId);
                patientDatabase[patientId] = currentPatient;
                alert(`New patient ${patientId} created!`);
            }
            
            updateUI();
        }

        function generateVirtualPatient() {
            const randomId = 'PT-2025-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            document.getElementById('patientId').value = randomId;
            
            const patient = initializePatient(randomId);
            patient.age = Math.floor(Math.random() * 60) + 20;
            patient.sex = Math.random() > 0.5 ? 'male' : 'female';
            patient.cancer = Math.random() > 0.5 ? 'leukemia' : 'lymphoma';
            
            if (Math.random() > 0.7) patient.chronicDiseases.push('diabetes');
            if (Math.random() > 0.6) patient.chronicDiseases.push('hypertension');
            
            patient.vitals.temperature = (36.5 + Math.random() * 1.5).toFixed(1);
            patient.vitals.bloodPressure = `${Math.floor(Math.random() * 40) + 110}/${Math.floor(Math.random() * 30) + 70}`;
            patient.vitals.heartRate = Math.floor(Math.random() * 40) + 60;
            
            currentPatient = patient;
            patientDatabase[randomId] = patient;
            
            updateUI();
            alert(`Virtual patient ${randomId} generated!\nAge: ${patient.age}, Sex: ${patient.sex}`);
        }

        function updateUI() {
            if (!currentPatient) return;
            
            document.getElementById('patientForm').classList.add('active');
            document.getElementById('resultsArea').classList.add('active');
            
            document.getElementById('currentPatientId').textContent = currentPatient.id;
            document.getElementById('age').value = currentPatient.age;
            document.getElementById('sex').value = currentPatient.sex;
            document.getElementById('cancer').value = currentPatient.cancer;
            document.getElementById('temperature').value = currentPatient.vitals.temperature;
            document.getElementById('bloodPressure').value = currentPatient.vitals.bloodPressure;
            document.getElementById('heartRate').value = currentPatient.vitals.heartRate;
            
            const chronicSelect = document.getElementById('chronicDiseases');
            Array.from(chronicSelect.options).forEach(option => {
                option.selected = currentPatient.chronicDiseases.includes(option.value);
            });
            
            updateDoseDisplay();
            document.getElementById('sessionCount').textContent = currentPatient.sessions.length;
            
            if (currentPatient.sessions.length > 0) {
                runSimulation();
            }
        }

        function updatePatientRealtime() {
            if (!currentPatient) return;
            
            currentPatient.age = parseInt(document.getElementById('age').value) || 45;
            currentPatient.sex = document.getElementById('sex').value;
            currentPatient.cancer = document.getElementById('cancer').value;
            currentPatient.vitals.temperature = parseFloat(document.getElementById('temperature').value) || 37.0;
            currentPatient.vitals.bloodPressure = document.getElementById('bloodPressure').value || '120/80';
            currentPatient.vitals.heartRate = parseInt(document.getElementById('heartRate').value) || 75;
            
            const chronicSelect = document.getElementById('chronicDiseases');
            currentPatient.chronicDiseases = Array.from(chronicSelect.selectedOptions).map(opt => opt.value);
            
            if (currentPatient.sessions.length > 0) {
                runSimulation();
            }
        }

        function updateDoseDisplay() {
            const dose = currentPatient.cumulativeDose;
            const maxDose = 550;
            const percentage = Math.min(100, (dose / maxDose) * 100);
            
            document.getElementById('cumulativeDoseDisplay').textContent = `${dose} mg/m²`;
            document.getElementById('doseProgressBar').style.width = `${percentage}%`;
            
            const progressBar = document.getElementById('doseProgressBar');
            if (percentage < 60) {
                progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (percentage < 80) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }
        }

        function addTreatmentSession() {
            if (!currentPatient) {
                alert('Please load or create a patient first!');
                return;
            }
            
            const sessionDose = 60;
            
            if (currentPatient.cumulativeDose + sessionDose > 600) {
                if (!confirm(`Warning: This will exceed recommended maximum dose. Continue?`)) {
                    return;
                }
            }
            
            currentPatient.cumulativeDose += sessionDose;
            
            const risks = calculateRisks(currentPatient);
            
            const relevantStudies = [];
            if (risks.cardioRisk > 20) {
                relevantStudies.push(...ragKnowledge.cardiotoxicity.studies);
            }
            if (risks.neutroRisk > 60) {
                relevantStudies.push(...ragKnowledge.hematotoxicity.studies);
            }
            
            const session = {
                date: new Date().toISOString(),
                sessionNumber: currentPatient.sessions.length + 1,
                dose: sessionDose,
                cumulativeDose: currentPatient.cumulativeDose,
                vitals: { ...currentPatient.vitals },
                risks: risks,
                studies: relevantStudies
            };
            
            currentPatient.sessions.push(session);
            
            updateDoseDisplay();
            document.getElementById('sessionCount').textContent = currentPatient.sessions.length;
            
            runSimulation();
            
            alert(`✅ Session ${session.sessionNumber} added!\nDose: ${sessionDose} mg/m²\nCumulative: ${currentPatient.cumulativeDose} mg/m²`);
        }

        function runSimulation() {
            if (!currentPatient || currentPatient.sessions.length === 0) return;
            
            const latestSession = currentPatient.sessions[currentPatient.sessions.length - 1];
            const risks = latestSession.risks;
            
            document.getElementById('cardioRisk').textContent = risks.cardioRisk + '%';
            document.getElementById('neutroRisk').textContent = risks.neutroRisk + '%';
            document.getElementById('anemiaRisk').textContent = risks.anemiaRisk + '%';
            document.getElementById('qualityScore').textContent = risks.overallScore;
            
            displayAlerts(risks, latestSession.studies);
            displayRAGInsights(latestSession.studies);
            displaySessionHistory();
            updateCharts();
            updatePatientView(risks);
        }

        function displayAlerts(risks, studies) {
            const alertsContainer = document.getElementById('clinicalAlerts');
            alertsContainer.innerHTML = '';
            
            if (risks.cardioRisk > 20) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>⚠️ High Cardiotoxicity Risk</h4>
                    <p><strong>Risk Level: ${risks.cardioRisk}%</strong></p>
                    <p>Immediate Actions: Consider dexrazoxane cardioprotection. Schedule echocardiogram. Monitor troponin levels.</p>
                `;
                alertsContainer.appendChild(alert);
            }
            
            if (risks.neutroRisk > 60) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>⚠️ High Neutropenia Risk</h4>
                    <p><strong>Risk Level: ${risks.neutroRisk}%</strong></p>
                    <p>Immediate Actions: Prophylactic G-CSF recommended. Monitor CBC closely.</p>
                `;
                alertsContainer.appendChild(alert);
            }
        }

        function displayRAGInsights(studies) {
            const container = document.getElementById('ragStudiesContainer');
            container.innerHTML = '';
            
            if (studies.length === 0) {
                container.innerHTML = '<p>No high-risk factors identified at current dose level.</p>';
                return;
            }
            
            studies.forEach(study => {
                const card = document.createElement('div');
                card.className = 'study-card';
                card.innerHTML = `
                    <h5>${study.title}</h5>
                    <p>${study.findings}</p>
                `;
                container.appendChild(card);
            });
        }

        function displaySessionHistory() {
            const container = document.getElementById('sessionHistoryList');
            container.innerHTML = '';
            
            currentPatient.sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'session-item';
                const date = new Date(session.date).toLocaleDateString();
                item.innerHTML = `
                    <h4>Session ${session.sessionNumber} - ${date}</h4>
                    <p><strong>Dose:</strong> ${session.dose} mg/m² | <strong>Cumulative:</strong> ${session.cumulativeDose} mg/m²</p>
                    <p><strong>Key Risks:</strong> Cardio: ${session.risks.cardioRisk}% | Neutro: ${session.risks.neutroRisk}% | Recovery: ${session.risks.overallScore}</p>
                `;
                container.appendChild(item);
            });
        }

        function updateCharts() {
            updateRiskChart();
            updateProgressChart();
            updatePatientJourneyChart();
        }

        function updateRiskChart() {
            const ctx = document.getElementById('riskChart');
            if (!ctx) return;
            
            const latestSession = currentPatient.sessions[currentPatient.sessions.length - 1];
            const risks = latestSession.risks;
            
            if (charts.riskChart) charts.riskChart.destroy();
            
            charts.riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cardio', 'Neutro', 'Anemia', 'Nausea', 'Fatigue'],
                    datasets: [{
                        label: 'Risk (%)',
                        data: [risks.cardioRisk, risks.neutroRisk, risks.anemiaRisk, risks.nauseaRisk, risks.fatigueRisk],
                        backgroundColor: ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateProgressChart() {
            const ctx = document.getElementById('progressChart');
            if (!ctx) return;
            
            const progressData = currentPatient.sessions.map((session, idx) => ({
                session: `S${idx + 1}`,
                cardio: session.risks.cardioRisk,
                neutro: session.risks.neutroRisk,
                score: session.risks.overallScore
            }));
            
            if (charts.progressChart) charts.progressChart.destroy();
            
            charts.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: progressData.map(d => d.session),
                    datasets: [
                        {
                            label: 'Recovery Score',
                            data: progressData.map(d => d.score),
                            borderColor: '#10b981',
                            tension: 0.4
                        },
                        {
                            label: 'Cardiotoxicity Risk',
                            data: progressData.map(d => d.cardio),
                            borderColor: '#ef4444',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updatePatientJourneyChart() {
            const ctx = document.getElementById('patientJourneyChart');
            if (!ctx) return;
            
            const journeyData = currentPatient.sessions.map((session, idx) => ({
                session: `Session ${idx + 1}`,
                overall: session.risks.overallScore
            }));
            
            if (charts.patientJourneyChart) charts.patientJourneyChart.destroy();
            
            charts.patientJourneyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: journeyData.map(d => d.session),
                    datasets: [{
                        label: 'Overall Health',
                        data: journeyData.map(d => d.overall),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updatePatientView(risks) {
            const noData = document.getElementById('noDataMessage');
            const dataContent = document.getElementById('patientDataContent');
            
            if (currentPatient.sessions.length === 0) {
                noData.style.display = 'block';
                dataContent.style.display = 'none';
                return;
            }
            
            noData.style.display = 'none';
            dataContent.style.display = 'block';
            
            updateRecoveryCircle(risks.overallScore);
            
            const heartScore = 100 - risks.cardioRisk;
            document.getElementById('patientHeartScore').textContent = Math.round(heartScore);
            document.getElementById('heartBar').style.width = heartScore + '%';
            
            const bloodScore = 100 - risks.neutroRisk;
            document.getElementById('patientBloodScore').textContent = Math.round(bloodScore);
            document.getElementById('bloodBar').style.width = bloodScore + '%';
            
            const energyScore = 100 - risks.fatigueRisk;
            document.getElementById('patientEnergyScore').textContent = Math.round(energyScore);
            document.getElementById('energyBar').style.width = energyScore + '%';
            
            updatePatientAdvice(risks);
        }

        function updateRecoveryCircle(score) {
            const svg = document.getElementById('recoveryCircleSVG');
            const numberDisplay = document.getElementById('recoveryScoreNumber');
            const messageDisplay = document.getElementById('recoveryMessage');
            
            const radius = 85;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score / 100) * circumference;
            
            let color = '#10b981';
            if (score < 40) color = '#ef4444';
            else if (score < 70) color = '#f59e0b';
            
            svg.innerHTML = `
                <circle cx="100" cy="100" r="85" fill="none" stroke="#e5e7eb" stroke-width="12"/>
                <circle cx="100" cy="100" r="85" fill="none" stroke="${color}" stroke-width="12"
                        stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                        transform="rotate(-90 100 100)" stroke-linecap="round"/>
            `;
            
            numberDisplay.textContent = score;
            
            if (score > 70) {
                messageDisplay.innerHTML = '🟢 <strong>Great Recovery!</strong> Your body is responding well.';
            } else if (score > 40) {
                messageDisplay.innerHTML = '🟡 <strong>Moderate Strain.</strong> Rest and hydration are important.';
            } else {
                messageDisplay.innerHTML = '🔴 <strong>High Strain.</strong> Please consult your care team.';
            }
        }

        function updatePatientAdvice(risks) {
            const adviceSection = document.getElementById('patientAdviceSection');
            
            let html = '<h3>📋 Your Personalized Care Guide</h3>';
            
            if (risks.cardioRisk > 20) {
                html += '<div style="background: #fee2e2; padding: 15px; border-radius: 10px; margin: 10px 0;">';
                html += '<h4 style="color: #991b1b;">❤️ Heart Health Alert</h4>';
                html += '<p>Your heart needs extra care. Eat heart-healthy foods, avoid smoking, and watch for chest pain.</p>';
                html += '</div>';
            }
            
            if (risks.nauseaRisk > 70) {
                html += '<div style="background: #d1fae5; padding: 15px; border-radius: 10px; margin: 10px 0;">';
                html += '<h4 style="color: #065f46;">Managing Nausea</h4>';
                html += '<p>Try ginger tea, eat small meals, and take anti-nausea meds as prescribed.</p>';
                html += '</div>';
            }
            
            if (risks.neutroRisk > 60) {
                html += '<div style="background: #dbeafe; padding: 15px; border-radius: 10px; margin: 10px 0;">';
                html += '<h4 style="color: #1e40af;">🛡️ Infection Prevention</h4>';
                html += '<p>Wash hands frequently, avoid crowds, and call doctor if fever >38°C.</p>';
                html += '</div>';
            }
            
            html += '<div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin: 10px 0;">';
            html += '<h4 style="color: #78350f;">💪 Daily Tips</h4>';
            html += '<ul><li>Drink 8 glasses of water</li><li>Take short walks</li><li>Get good sleep</li><li>Eat protein-rich foods</li></ul>';
            html += '</div>';
            
            adviceSection.innerHTML = html;
        }

        function switchView(mode) {
            currentView = mode;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const doctorView = document.getElementById('doctorView');
            const patientView = document.getElementById('patientView');
            
            if (mode === 'patient') {
                doctorView.style.display = 'none';
                patientView.style.display = 'block';
                if (currentPatient && currentPatient.sessions.length > 0) {
                    const latestRisks = currentPatient.sessions[currentPatient.sessions.length - 1].risks;
                    updatePatientView(latestRisks);
                }
            } else {
                doctorView.style.display = 'block';
                patientView.style.display = 'none';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (20 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        window.onload = function() {
            createParticles();
            console.log('ChemoTwin RAG System initialized!');
        };
    </script>
</body>
</html>