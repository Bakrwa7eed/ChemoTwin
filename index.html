<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemoTwin: Digital Twins for Chemotherapy Effects</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 200px;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e6f0fa 0%, #d0e4ff 100%);
            z-index: -2;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 102, 204, 0.2);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); }
            100% { transform: translateY(-100vh) translateX(100px); }
        }

        /* BLUETOOTH SIDEBAR */
        .bluetooth-sidebar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 102, 204, 0.15);
            border: 1px solid rgba(0, 102, 204, 0.2);
            z-index: 1000;
            width: 280px;
            display: none;
        }

        .bluetooth-sidebar.active {
            display: block;
        }

        .bluetooth-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(0, 102, 204, 0.1);
        }

        .bluetooth-icon {
            font-size: 24px;
            color: #0066cc;
        }

        .bluetooth-title {
            font-size: 1em;
            font-weight: 600;
            color: #0066cc;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #94a3b8;
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .device-status-text {
            font-size: 0.85em;
            color: #475569;
            font-weight: 500;
        }

        .vitals-display {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .vital-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .vital-item:last-child {
            border-bottom: none;
        }

        .vital-label {
            font-size: 0.8em;
            color: #64748b;
            font-weight: 500;
        }

        .vital-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #0066cc;
        }

        .btn-connect {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #0066cc, #3399ff);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.3);
        }

        .btn-disconnect {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 102, 204, 0.1);
        }

        .header h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, #0066cc, #3399ff, #0066cc);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
            margin-bottom: 10px;
            text-align: center;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .subtitle {
            color: #555;
            font-size: 1.05em;
            text-align: center;
            margin-bottom: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .view-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            background: #e2e8f0;
            color: #64748b;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #0066cc, #3399ff);
            color: white;
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.3);
        }

        .view-btn:hover {
            transform: translateY(-2px);
        }

        .patient-id-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 102, 204, 0.1);
        }

        .patient-id-section h2 {
            color: #0066cc;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .id-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .patient-id-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .patient-id-input:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 20px rgba(0, 102, 204, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0066cc, #3399ff);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
            .bluetooth-sidebar {
                position: static;
                transform: none;
                margin-bottom: 20px;
                width: 100%;
            }
        }

        .input-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 20px;
            padding: 25px;
            height: fit-content;
            display: none;
        }

        .input-panel.active {
            display: block;
        }

        .input-panel h2 {
            color: #0066cc;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        #currentPatientId {
            color: #10b981;
            font-weight: bold;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 102, 204, 0.1);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            color: #0066cc;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            background: rgba(230, 240, 250, 0.5);
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 8px;
            color: #333;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #0066cc;
            background: rgba(230, 240, 250, 0.8);
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
        }

        .dose-display {
            background: rgba(230, 240, 250, 0.5);
            border: 2px solid rgba(0, 102, 204, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .dose-display label {
            display: block;
            color: #0066cc;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .dose-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .dose-progress {
            width: 100%;
            height: 10px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .dose-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .dose-display small {
            color: #666;
            font-size: 0.85em;
        }

        .btn-add-session {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-session:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .session-count {
            margin-top: 15px;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
        }

        .session-count span {
            color: #10b981;
            font-weight: bold;
            font-size: 1.2em;
        }

        .results-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 20px;
            padding: 25px;
            min-height: 600px;
            display: none;
        }

        .results-panel.active {
            display: block;
        }

        .results-panel h2 {
            color: #0066cc;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 102, 204, 0.2);
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-weight: 500;
            font-size: 0.95em;
        }

        .tab:hover {
            color: #0066cc;
        }

        .tab.active {
            color: #0066cc;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0066cc, #3399ff);
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert h4 {
            color: #991b1b;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .alert p {
            color: #7f1d1d;
            font-size: 0.95em;
            line-height: 1.6;
            margin: 5px 0;
        }

        .alert ul {
            margin: 10px 0 10px 20px;
            color: #7f1d1d;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: rgba(230, 240, 250, 0.6);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .metric-card:hover {
            background: rgba(230, 240, 250, 0.9);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 102, 204, 0.2);
        }

        .metric-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #0066cc, #3399ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }

        .metric-label {
            color: #555;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .digital-twin-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .study-card {
            background: white;
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .study-card:hover {
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.15);
            transform: translateX(5px);
        }

        .study-card h5 {
            color: #0066cc;
            margin-bottom: 10px;
            font-size: 1.05em;
            font-weight: 600;
        }

        .study-card p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.7;
            margin-bottom: 10px;
        }

        .study-card .relevance-tag {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 8px;
        }

        .study-card cite {
            color: #888;
            font-size: 0.85em;
            font-style: italic;
            display: block;
            margin-top: 8px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #0066cc;
            margin-bottom: 15px;
        }

        canvas {
            max-width: 100%;
            height: 300px !important;
        }

        .session-item {
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(230, 240, 250, 0.4);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .session-item:hover {
            background: rgba(230, 240, 250, 0.7);
            transform: translateX(5px);
        }

        .session-item h4 {
            color: #0066cc;
            margin-bottom: 8px;
        }

        .session-item p {
            color: #555;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .no-data-message {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .recovery-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 20px;
            color: white;
            margin-bottom: 25px;
        }

        .recovery-circle {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .recovery-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: white;
        }

        .patient-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .patient-metric-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .patient-metric-card.heart {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .patient-metric-card.blood {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .patient-metric-card.energy {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
        }

        .patient-metric-card .metric-title {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .heart .metric-bar-fill {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .blood .metric-bar-fill {
            background: linear-gradient(90deg, #2563eb, #3b82f6);
        }

        .energy .metric-bar-fill {
            background: linear-gradient(90deg, #ca8a04, #eab308);
        }

        .patient-advice {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            padding: 20px;
            line-height: 1.8;
        }

        .twin-analysis-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .twin-analysis-box h4 {
            color: #0369a1;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .twin-analysis-box p {
            color: #075985;
            line-height: 1.7;
            margin: 8px 0;
        }

        .twin-analysis-box ul {
            margin: 8px 0 8px 20px;
            color: #075985;
        }

        /* FOOTER SECTION */
        .footer {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 50px 20px 30px;
            margin-top: 60px;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 30px;
        }

        .footer-section h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .footer-section p {
            color: #cbd5e1;
            line-height: 1.8;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .footer-section a {
            color: #93c5fd;
            text-decoration: none;
            transition: all 0.3s;
            display: block;
            margin-bottom: 8px;
        }

        .footer-section a:hover {
            color: #60a5fa;
            transform: translateX(5px);
        }

        .contact-info {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 12px;
        }

        .contact-icon {
            color: #3b82f6;
            font-size: 1.2em;
            margin-top: 2px;
        }

        .footer-bottom {
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            padding-top: 25px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.9em;
        }

        .copyright {
            margin-bottom: 10px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #93c5fd;
            text-decoration: none;
            transition: all 0.3s;
        }

        .footer-links a:hover {
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>
    
    <!-- BLUETOOTH SIDEBAR -->
    <div class="bluetooth-sidebar" id="bluetoothSidebar">
        <div class="bluetooth-header">
            <div class="bluetooth-icon">🔵</div>
            <div class="bluetooth-title">Device Monitor if you want to test</div>
        </div>
        
        <div class="device-status">
            <div class="status-dot" id="deviceStatusDot"></div>
            <div class="device-status-text" id="deviceStatusText">No device connected</div>
        </div>
        
        <div class="vitals-display" id="vitalsDisplay" style="display:none;">
            <div class="vital-item">
                <span class="vital-label">Heart Rate</span>
                <span class="vital-value" id="sidebarHR">-- bpm</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Blood Pressure</span>
                <span class="vital-value" id="sidebarBP">--/--</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Temperature</span>
                <span class="vital-value" id="sidebarTemp">-- °C</span>
            </div>
        </div>
        
        <button class="btn-connect" id="connectBtn" onclick="connectBluetoothDevice()">
            Connect Device
        </button>
    </div>
    
    <div class="main-container">
        <header class="header">
            <h1>ChemoTwin Clinical Platform</h1>
            <p class="subtitle">Evidence-Based Digital Twins for Chemotherapy Effects with RAG-Powered Insights</p>
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('doctor')">Clinical Dashboard</button>
                <button class="view-btn" onclick="switchView('patient')">Patient View</button>
            </div>
        </header>
        
        <div class="patient-id-section">
            <h2>Patient Identification & Management</h2>
            <div class="id-controls">
                <input type="text" id="patientId" placeholder="Enter Patient ID (e.g., PT-2025-001)" class="patient-id-input">
                <button onclick="loadPatient()" class="btn btn-primary">Load Patient</button>
                <button onclick="generateVirtualPatient()" class="btn btn-success">Generate Virtual Patient</button>
                <button onclick="exportPatientReport()" class="btn btn-secondary" id="exportBtn" style="display:none;">Export Report</button>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="input-panel" id="patientForm">
                <h2>Patient Profile - <span id="currentPatientId">No Patient Loaded</span></h2>
                
                <div class="form-section">
                    <h3>Demographics</h3>
                    <div class="input-group">
                        <label>Age (years)</label>
                        <input type="number" id="age" min="1" max="100" value="45" oninput="updatePatientRealtime()">
                    </div>
                    
                    <div class="input-group">
                        <label>Sex</label>
                        <select id="sex" onchange="updatePatientRealtime()">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Cancer Type</label>
                        <select id="cancer" onchange="updatePatientRealtime()">
                            <option value="leukemia">Leukemia</option>
                            <option value="lymphoma">Lymphoma</option>
                            
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Chronic Diseases (Ctrl+Click for multiple)</label>
                        <select id="chronicDiseases" multiple onchange="updatePatientRealtime()">
                            <option value="diabetes">Diabetes</option>
                            <option value="hypertension">Hypertension</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Current Vitals</h3>
                    <div class="input-group">
                        <label>Temperature (°C)</label>
                        <input type="number" id="temperature" step="0.1" min="35" max="42" value="37.0" oninput="updatePatientRealtime()">
                    </div>
                    
                    <div class="input-group">
                        <label>Blood Pressure (mmHg)</label>
                        <input type="text" id="bloodPressure" placeholder="120/80" value="120/80" oninput="updatePatientRealtime()">
                    </div>
                    
                    <div class="input-group">
                        <label>Heart Rate (bpm)</label>
                        <input type="number" id="heartRate" min="40" max="200" value="75" oninput="updatePatientRealtime()">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Treatment Information</h3>
                    <div class="dose-display">
                        <label>Cumulative Dose</label>
                        <div class="dose-value" id="cumulativeDoseDisplay">0 mg/m²</div>
                        <div class="dose-progress">
                            <div class="dose-progress-bar" id="doseProgressBar" style="width: 0%"></div>
                        </div>
                        <small>Maximum recommended: 550 mg/m²</small>
                    </div>
                    
                    <button class="btn-add-session" onclick="addTreatmentSession()">
                        Add Treatment Session (60 mg/m²)
                    </button>
                </div>
                
                <div class="session-count">
                    <strong>Total Sessions:</strong> <span id="sessionCount">0</span>
                </div>
            </div>
            
            <div class="results-panel" id="resultsArea">
                <h2>Analysis Results <span class="digital-twin-badge">Digital Twin Active</span></h2>
                
                <div id="doctorView">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('overview')">Overview</button>
                        <button class="tab" onclick="switchTab('rag-insights')">RAG Insights</button>
                        <button class="tab" onclick="switchTab('history')">Patient History</button>
                    </div>
                    
                    <div id="overview" class="tab-content active">
                        <div id="digitalTwinAnalysis"></div>
                        <div id="clinicalAlerts"></div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-icon"></div>
                                <div class="metric-value" id="cardioRisk">--</div>
                                <div class="metric-label">Cardiotoxicity Risk (%)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon"></div>
                                <div class="metric-value" id="neutroRisk">--</div>
                                <div class="metric-label">Neutropenia Risk (%)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon"></div>
                                <div class="metric-value" id="anemiaRisk">--</div>
                                <div class="metric-label">Anemia Risk (%)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon"></div>
                                <div class="metric-value" id="qualityScore">--</div>
                                <div class="metric-label">Recovery Score</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>Personalized Risk Distribution <span class="digital-twin-badge">Patient-Specific</span></h3>
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="rag-insights" class="tab-content">
                        <h3>Evidence-Based Clinical Insights</h3>
                        <p style="color: #666; margin-bottom: 20px;">Studies relevant to this patient's specific risk profile</p>
                        <div id="ragStudiesContainer"></div>
                    </div>
                    
                    <div id="history" class="tab-content">
                        <h3>Treatment History & Progress</h3>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div id="sessionHistoryList"></div>
                    </div>
                </div>
                
                <div id="patientView" style="display: none;">
                    <div id="noDataMessage" class="no-data-message">
                        <div class="icon"></div>
                        <p>Add your first treatment session to see your personalized health journey</p>
                    </div>
                    
                    <div id="patientDataContent" style="display: none;">
                        <div class="recovery-section">
                            <h3>Your Recovery Score</h3>
                            <div class="recovery-circle">
                                <svg width="200" height="200" id="recoveryCircleSVG"></svg>
                                <div class="recovery-number" id="recoveryScoreNumber">--</div>
                            </div>
                            <p class="recovery-message" id="recoveryMessage"></p>
                        </div>
                        
                        <div class="patient-metrics-grid">
                            <div class="patient-metric-card heart">
                                <div class="metric-icon"></div>
                                <div class="metric-title">Heart Health</div>
                                <div class="metric-value" id="patientHeartScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="heartBar"></div>
                                </div>
                            </div>
                            
                            <div class="patient-metric-card blood">
                                <div class="metric-icon"></div>
                                <div class="metric-title">Blood Health</div>
                                <div class="metric-value" id="patientBloodScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="bloodBar"></div>
                                </div>
                            </div>
                            
                            <div class="patient-metric-card energy">
                                <div class="metric-icon"></div>
                                <div class="metric-title">Energy Level</div>
                                <div class="metric-value" id="patientEnergyScore">--</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="energyBar"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>Your Health Journey</h3>
                            <canvas id="patientJourneyChart"></canvas>
                        </div>
                        
                        <div class="patient-advice" id="patientAdviceSection"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FOOTER -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About ChemoTwin</h3>
                <p>ChemoTwin is an advanced digital twin platform leveraging artificial intelligence and evidence-based research to personalize chemotherapy treatment planning and monitoring.</p>
                <p style="margin-top: 15px;">Developed as part of cutting-edge research in precision oncology and computational medicine.</p>
            </div>
            
            <div class="footer-section">
                <h3>Contact Information</h3>
                <div class="contact-info">
                    <span class="contact-icon">👤</span>
                    <div>
                        <p><strong>Bakr Waheed</strong></p>
                        <p>Developer & Researcher</p>
                    </div>
                </div>
                <div class="contact-info">
                    <span class="contact-icon">✉️</span>
                    <div>
                        <a href="mailto:bakrwaheed0@gmail.com">bakrwaheed0@gmail.com</a>
                        <a href="mailto:bakr.salheen@student.giu-uni.de">bakr.salheen@student.giu-uni.de</a>
                    </div>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Resources</h3>
                <a href="https://github.com/Bakrwa7eed/ChemoTwin/blob/main/documentation.pdf" target="_blank">📄 Documentation</a>
                <a href="https://github.com/Bakrwa7eed/ChemoTwin" target="_blank">💻 GitHub Repository</a>
                <a href="https://www.linkedin.com/in/bakr-waheed-1a127a30a/" target="_blank">🔗 LinkedIn Profile</a>
                <a href="#" onclick="alert('Research papers available upon request'); return false;">📚 Research Papers</a>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <a href="#" onclick="alert('Privacy Policy: This platform uses secure storage for patient data. All information is encrypted and stored locally.'); return false;">Privacy Policy</a>
                <a href="#" onclick="alert('Terms of Service: This is a research platform. Always consult with qualified healthcare professionals for medical decisions.'); return false;">Terms of Service</a>
                <a href="#" onclick="alert('Medical Disclaimer: This platform is for research and educational purposes. Not intended to replace professional medical advice.'); return false;">Medical Disclaimer</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="copyright">
                © 2025 ChemoTwin Platform. All rights reserved. | Developed by <strong>Bakr Waheed</strong>
            </div>
            <div class="footer-links">
                <a href="https://github.com/Bakrwa7eed/ChemoTwin" target="_blank">GitHub</a>
                <span style="color: #475569;">•</span>
                <a href="https://www.linkedin.com/in/bakr-waheed-1a127a30a/" target="_blank">LinkedIn</a>
                <span style="color: #475569;">•</span>
                <a href="mailto:bakrwaheed0@gmail.com">Contact</a>
            </div>
            <p style="margin-top: 15px; font-size: 0.85em; color: #64748b;">
                Medical AI Research Platform | Version 2.0 | Last Updated: January 2025
            </p>
        </div>
    </footer>
    
    <script>
        // Global state
        let currentPatient = null;
        let currentView = 'doctor';
        let charts = {};
        let bluetoothDevice = null;
        let heartRateCharacteristic = null;

        // EMAIL NOTIFICATION FUNCTION
        async function sendEmailNotification(data) {
            const emailData = {
                to: 'bakrwaheed0@gmail.com',
                subject: `ChemoTwin - New Patient Entry: ${data.patientId}`,
                body: `
NEW PATIENT ENTRY NOTIFICATION

Patient ID: ${data.patientId}
Entry Time: ${new Date(data.timestamp).toLocaleString()}

Demographics:
- Age: ${data.age} years
- Sex: ${data.sex}
- Cancer Type: ${data.cancer}
- Chronic Diseases: ${data.chronicDiseases.join(', ') || 'None'}

Current Vitals:
- Temperature: ${data.vitals.temperature}°C
- Blood Pressure: ${data.vitals.bloodPressure}
- Heart Rate: ${data.vitals.heartRate} bpm

Treatment Status:
- Total Sessions: ${data.sessions.length}
- Cumulative Dose: ${data.cumulativeDose} mg/m²

${data.sessions.length > 0 ? `
Latest Risk Profile:
- Cardiotoxicity Risk: ${data.latestRisks.cardioRisk}%
- Neutropenia Risk: ${data.latestRisks.neutroRisk}%
- Recovery Score: ${data.latestRisks.overallScore}
` : ''}

---
This is an automated notification from ChemoTwin Platform.
                `
            };
            
            console.log('EMAIL NOTIFICATION:', emailData);
            
            try {
                await window.storage.set(
                    `email_log:${data.patientId}_${data.timestamp}`,
                    JSON.stringify(emailData),
                    true
                );
            } catch (error) {
                console.log('Email log stored in memory');
            }
        }

        // Track visitor on page load
        async function trackVisitor() {
            const visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const timestamp = new Date().toISOString();
            
            const visitorData = {
                id: visitorId,
                timestamp: timestamp,
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                language: navigator.language
            };
            
            try {
                await window.storage.set(`visitor:${visitorId}`, JSON.stringify(visitorData), true);
                console.log('Visitor tracked:', visitorId);
            } catch (error) {
                console.log('Visitor tracking stored in memory');
            }
            
            const emailData = {
                to: 'bakrwaheed0@gmail.com',
                subject: 'ChemoTwin - New Website Visitor',
                body: `New visitor accessed ChemoTwin Platform\n\nTime: ${new Date(timestamp).toLocaleString()}\nVisitor ID: ${visitorId}\nUser Agent: ${navigator.userAgent}`
            };
            console.log('VISITOR EMAIL:', emailData);
        }

        // ENHANCED RAG Knowledge Base with 2022+ studies
        const ragKnowledge = {
            cardiotoxicity: {
                studies: [
                    {
                        title: "Wu et al. (2022) - MRI-based Digital Twins for TNBC Treatment Optimization",
                        findings: "Framework integrates dynamic contrast-enhanced and diffusion-weighted MRI with biology-based mathematical models to predict triple-negative breast cancer response to neoadjuvant chemotherapy. Study of 105 ARTEMIS trial patients showed digital twins achieved AUC 0.89 for pathological complete response prediction with 72% sensitivity and 95% specificity. Patient-specific optimization from 128 treatment schedules improved pCR rates by 20.95-24.76%.",
                        dosageThreshold: 180,
                        highRiskDose: 480,
                        citation: "Wu C, et al. npj Digital Medicine. 2025;8(195). doi:10.1038/s41746-025-01579-1",
                        relevance: "High relevance for breast cancer patients receiving anthracycline-based therapy",
                        year: 2022,
                        cancerType: ['breast']
                    },
                    {
                        title: "Sager (2023) - Digital Twins in Oncology for Hematopoietic Tumors",
                        findings: "Conceptual framework for mathematical modeling of cancer dynamics in hematopoietic and lymphoid tissues. Discusses three-component digital twin architecture: physical entity (patient), digital representation (mathematical models), and bidirectional information exchange. Advocates for patient-specific models to optimize drug administration and immune modulation.",
                        dosageThreshold: 200,
                        citation: "Sager S. J Cancer Res Clin Oncol. 2023;149(9):5475-5477. doi:10.1007/s00432-023-04633-1",
                        relevance: "Applicable to leukemia and lymphoma patients",
                        year: 2023,
                        cancerType: ['leukemia', 'lymphoma']
                    },
                    {
                        title: "Wang et al. (2024) - Virtual Patients to Digital Twins in Immuno-Oncology",
                        findings: "Mechanistic QSP modeling evolution from virtual patients to personalized digital twins. Addresses oncology's 3.4% Phase I to approval success rate. Digital twins enable real-time treatment optimization. Over one-fifth of FDA-submitted QSP models (2013-2020) were for oncology.",
                        dosageThreshold: 240,
                        citation: "Wang H, et al. npj Digital Medicine. 2024;7(189). doi:10.1038/s41746-024-01188-4",
                        relevance: "Universal applicability for treatment optimization",
                        year: 2024,
                        cancerType: ['leukemia', 'lymphoma', 'breast']
                    },
                    {
                        title: "Heudel et al. (2025) - AI Digital Twins for Geriatric Breast Cancer",
                        findings: "AI and digital twins for women 70+ with HER2-negative breast cancer. Analyzed 793 patients achieving mean AUC 0.81 for 5-year mortality prediction. Digital twins map patient profiles into 3D space estimating chemotherapy benefits. Outperforms PREDICT and Adjuvant! Online tools.",
                        dosageThreshold: 200,
                        citation: "Heudel P, et al. JMIR Cancer. 2025;11:e64000. doi:10.2196/64000",
                        relevance: "Critical for elderly patients (70+) with comorbidities",
                        year: 2025,
                        cancerType: ['breast']
                    }
                ]
            },
            hematotoxicity: {
                studies: [
                    {
                        title: "Reimann et al. (2025) - Digital Twin G-CSF Optimization in AML",
                        findings: "Physiologically-based digital twin models optimize G-CSF schedules in AML patients undergoing cytarabine consolidation. Patient-specific calibration explores alternative regimens to accelerate WBC recovery while minimizing costs and side effects. Enables virtual clinical trials for treatment efficiency.",
                        riskPercentage: 65,
                        citation: "Reimann AM, et al. medRxiv. 2025. doi:10.1101/2025.07.17.25331695",
                        relevance: "Essential for AML and leukemia patients on consolidation therapy",
                        year: 2025,
                        cancerType: ['leukemia']
                    },
                    {
                        title: "Kaul et al. (2023) - AI Digital Twins for Cancer Care",
                        findings: "Framework combining digital twins with AI for patient-centric cancer care. Integrates heterogeneous data (imaging, genomics) for real-time simulation. AI facilitates diagnosis, treatment planning, and toxicity prediction. Advocates for high-value care through interdisciplinary collaboration.",
                        riskPercentage: 70,
                        citation: "Kaul R, et al. WIREs Data Mining Knowl Discov. 2023;13:e1480. doi:10.1002/widm.1480",
                        relevance: "Framework applicable to all cancer types",
                        year: 2023,
                        cancerType: ['leukemia', 'lymphoma', 'breast']
                    },
                    {
                        title: "Bouriga et al. (2025) - Digital Twins in Anticancer Drug Development",
                        findings: "Digital twins as dynamic, AI-driven platforms replicating patient/tumor characteristics. Enable virtual trials, comparing in-silico with real data. Applications include immunotherapy simulation and FDA-mandated R&D. Advocates interdisciplinary approach to accelerate personalized oncology.",
                        riskPercentage: 60,
                        citation: "Bouriga R, et al. Brief Bioinform. 2025;26(3):bbaf237. doi:10.1093/bib/bbaf237",
                        relevance: "Methodological framework for trial design",
                        year: 2025,
                        cancerType: ['leukemia', 'lymphoma', 'breast']
                    }
                ]
            },
            advanced: {
                studies: [
                    {
                        title: "Baumgartner (2022) - Digital Cell Twin in Cancer Electrophysiology",
                        findings: "First digital twin of A549 cell electrophysiology in lung adenocarcinoma. Simulates ion channel dynamics and membrane potential oscillations. Enables virtual testing of ion channel modulation for cell cycle arrest. Complements in-vivo/in-vitro with 'dry lab' simulations.",
                        citation: "Baumgartner C. J Exp Clin Cancer Res. 2022;41(298). doi:10.1186/s13046-022-02507-x",
                        relevance: "Cellular-level digital twin for mechanism-based therapy",
                        year: 2022,
                        cancerType: ['leukemia', 'lymphoma', 'breast']
                    },
                    {
                        title: "Shen et al. (2025) - Digital Twins in Tumor Therapy Review",
                        findings: "Systematic review of digital twin trends through 2024. Research surged post-2020, led by US, Germany, Switzerland, China. DTs integrate multimodal data with AI for dynamic modeling. Challenges: data heterogeneity, bias, privacy. Advocates international collaboration and unified standards.",
                        citation: "Shen S, et al. J Transl Med. 2025;23(348). doi:10.1186/s12967-025-06371-z",
                        relevance: "Comprehensive overview of digital twin applications",
                        year: 2025,
                        cancerType: ['leukemia', 'lymphoma', 'breast']
                    }
                ]
            }
        };

        // DIGITAL TWIN RISK CALCULATOR
        function calculateDigitalTwinRisks(patient) {
            const { age, sex, cumulativeDose, chronicDiseases, vitals, cancer } = patient;
            const dose = cumulativeDose;
            
            let cardioBase = 0;
            if (dose > 550) cardioBase = 36;
            else if (dose > 450) cardioBase = 24;
            else if (dose > 300) cardioBase = 12;
            else if (dose > 200) cardioBase = 5;
            else cardioBase = 1;
            
            let cardioModifiers = [];
            
            if (age < 18) {
                cardioBase += 8;
                cardioModifiers.push(`Pediatric age (${age}yo) adds +8% risk`);
            } else if (age > 65) {
                cardioBase += 10;
                cardioModifiers.push(`Advanced age (${age}yo) adds +10% risk`);
            }
            
            if (sex === 'female') {
                cardioBase += 4;
                cardioModifiers.push("Female sex adds +4% risk");
            }
            
            if (chronicDiseases.includes('diabetes')) {
                cardioBase += 12;
                cardioModifiers.push("Diabetes adds +12% risk");
            }
            if (chronicDiseases.includes('hypertension')) {
                cardioBase += 10;
                cardioModifiers.push("Hypertension adds +10% risk");
            }
            
            const systolic = parseInt(vitals.bloodPressure.split('/')[0]);
            if (systolic > 140) {
                cardioBase += 6;
                cardioModifiers.push(`Elevated BP adds +6% risk`);
            }
            
            if (vitals.heartRate > 100) {
                cardioBase += 5;
                cardioModifiers.push(`Tachycardia adds +5% risk`);
            }
            
            const cardioRisk = Math.min(95, Math.round(cardioBase));
            
            let neutroBase = 35 + (dose / 600 * 45);
            let neutroModifiers = [];
            
            if (age > 65) {
                neutroBase += 12;
                neutroModifiers.push(`Age ${age} adds +12%`);
            }
            if (cancer === 'leukemia') {
                neutroBase += 18;
                neutroModifiers.push("Leukemia adds +18%");
            }
            
            const neutroRisk = Math.min(95, Math.round(neutroBase));
            
            let anemiaBase = 30 + (dose / 600 * 45);
            if (sex === 'female') anemiaBase += 8;
            const anemiaRisk = Math.min(90, Math.round(anemiaBase));
            
            let nauseaBase = 82;
            if (sex === 'female') nauseaBase += 10;
            const nauseaRisk = Math.min(98, Math.round(nauseaBase));
            
            let fatigueBase = 55 + (dose / 600 * 35);
            if (age > 60) fatigueBase += 10;
            const fatigueRisk = Math.min(95, Math.round(fatigueBase));
            
            let mucositisBase = 25 + (dose / 600 * 35);
            const mucositisRisk = Math.min(85, Math.round(mucositisBase));
            
            const overallScore = Math.round(100 - ((cardioRisk + neutroRisk + fatigueRisk) / 3) * 0.8);
            
            return {
                cardioRisk, cardioModifiers, neutroRisk, neutroModifiers,
                anemiaRisk, nauseaRisk, fatigueRisk, mucositisRisk, overallScore
            };
        }

        // SMART RAG QUERY
        function queryRAG(patient) {
            const risks = calculateDigitalTwinRisks(patient);
            const dose = patient.cumulativeDose;
            let relevantStudies = [];
            
            if (dose >= 180 || risks.cardioRisk > 15) {
                ragKnowledge.cardiotoxicity.studies.forEach(study => {
                    if (study.cancerType.includes(patient.cancer) && 
                        (!study.dosageThreshold || dose >= study.dosageThreshold)) {
                        relevantStudies.push({
                            ...study,
                            category: 'Cardiotoxicity',
                            patientRelevance: `Dose: ${dose} mg/m², Cancer: ${patient.cancer}`
                        });
                    }
                });
            }
            
            if (dose > 0 || risks.neutroRisk > 40) {
                ragKnowledge.hematotoxicity.studies.forEach(study => {
                    if (study.cancerType.includes(patient.cancer)) {
                        relevantStudies.push({
                            ...study,
                            category: 'Hematotoxicity',
                            patientRelevance: `${patient.cancer} with ${risks.neutroRisk}% neutropenia risk`
                        });
                    }
                });
            }
            
            if (dose >= 120) {
                ragKnowledge.advanced.studies.forEach(study => {
                    if (study.cancerType.includes(patient.cancer)) {
                        relevantStudies.push({
                            ...study,
                            category: 'Advanced Methods',
                            patientRelevance: `Methodology for ${patient.cancer} treatment`
                        });
                    }
                });
            }
            
            return { studies: relevantStudies };
        }

        // Initialize patient
        function initializePatient(id) {
            return {
                id: id,
                age: 45,
                sex: 'male',
                cancer: 'lymphoma',
                chronicDiseases: [],
                vitals: {
                    temperature: 37.0,
                    bloodPressure: '120/80',
                    heartRate: 75
                },
                cumulativeDose: 0,
                sessions: [],
                createdAt: new Date().toISOString()
            };
        }

        async function loadPatient() {
            const patientId = document.getElementById('patientId').value.trim();
            
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }
            
            try {
                const result = await window.storage.get(`patient:${patientId}`);
                if (result) {
                    currentPatient = JSON.parse(result.value);
                    alert(`Patient ${patientId} loaded!\n\nSessions: ${currentPatient.sessions.length}\nDose: ${currentPatient.cumulativeDose} mg/m²`);
                } else {
                    currentPatient = initializePatient(patientId);
                    await window.storage.set(`patient:${patientId}`, JSON.stringify(currentPatient));
                    
                    await sendEmailNotification({
                        patientId: currentPatient.id,
                        timestamp: currentPatient.createdAt,
                        age: currentPatient.age,
                        sex: currentPatient.sex,
                        cancer: currentPatient.cancer,
                        chronicDiseases: currentPatient.chronicDiseases,
                        vitals: currentPatient.vitals,
                        sessions: currentPatient.sessions,
                        cumulativeDose: currentPatient.cumulativeDose,
                        latestRisks: {}
                    });
                    
                    alert(`New patient ${patientId} created!\n\nEmail notification sent.`);
                }
            } catch (error) {
                currentPatient = initializePatient(patientId);
                alert(`New patient ${patientId} created!`);
            }
            
            updateUI();
        }

        function generateVirtualPatient() {
            const randomId = 'PT-2025-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            document.getElementById('patientId').value = randomId;
            
            const patient = initializePatient(randomId);
            patient.age = Math.floor(Math.random() * 60) + 20;
            patient.sex = Math.random() > 0.5 ? 'male' : 'female';
            patient.cancer = ['leukemia', 'lymphoma'][Math.floor(Math.random() * 3)];
            
            if (Math.random() > 0.7) patient.chronicDiseases.push('diabetes');
            if (Math.random() > 0.6) patient.chronicDiseases.push('hypertension');
            
            patient.vitals.temperature = (36.5 + Math.random() * 1.5).toFixed(1);
            patient.vitals.bloodPressure = `${Math.floor(Math.random() * 40) + 110}/${Math.floor(Math.random() * 30) + 70}`;
            patient.vitals.heartRate = Math.floor(Math.random() * 40) + 60;
            
            currentPatient = patient;
            savePatientData();
            
            sendEmailNotification({
                patientId: currentPatient.id,
                timestamp: currentPatient.createdAt,
                age: currentPatient.age,
                sex: currentPatient.sex,
                cancer: currentPatient.cancer,
                chronicDiseases: currentPatient.chronicDiseases,
                vitals: currentPatient.vitals,
                sessions: currentPatient.sessions,
                cumulativeDose: currentPatient.cumulativeDose,
                latestRisks: {}
            });
            
            updateUI();
            alert(`Virtual patient generated!\n\nID: ${randomId}\nAge: ${patient.age}\nSex: ${patient.sex}\nCancer: ${patient.cancer}`);
        }

        async function savePatientData() {
            if (!currentPatient) return;
            
            try {
                await window.storage.set(`patient:${currentPatient.id}`, JSON.stringify(currentPatient));
            } catch (error) {
                console.log('Data stored in session');
            }
        }

        function updateUI() {
            if (!currentPatient) return;
            
            document.getElementById('patientForm').classList.add('active');
            document.getElementById('resultsArea').classList.add('active');
            document.getElementById('exportBtn').style.display = 'inline-block';
            document.getElementById('bluetoothSidebar').classList.add('active');
            
            document.getElementById('currentPatientId').textContent = currentPatient.id;
            document.getElementById('age').value = currentPatient.age;
            document.getElementById('sex').value = currentPatient.sex;
            document.getElementById('cancer').value = currentPatient.cancer;
            document.getElementById('temperature').value = currentPatient.vitals.temperature;
            document.getElementById('bloodPressure').value = currentPatient.vitals.bloodPressure;
            document.getElementById('heartRate').value = currentPatient.vitals.heartRate;
            
            updateSidebarVitals();
            
            const chronicSelect = document.getElementById('chronicDiseases');
            Array.from(chronicSelect.options).forEach(option => {
                option.selected = currentPatient.chronicDiseases.includes(option.value);
            });
            
            updateDoseDisplay();
            document.getElementById('sessionCount').textContent = currentPatient.sessions.length;
            
            if (currentPatient.sessions.length > 0) {
                runSimulation();
            }
        }

        function updateSidebarVitals() {
            if (!currentPatient) return;
            document.getElementById('sidebarHR').textContent = currentPatient.vitals.heartRate + ' bpm';
            document.getElementById('sidebarBP').textContent = currentPatient.vitals.bloodPressure;
            document.getElementById('sidebarTemp').textContent = currentPatient.vitals.temperature + ' °C';
        }

        function updatePatientRealtime() {
            if (!currentPatient) return;
            
            currentPatient.age = parseInt(document.getElementById('age').value) || 45;
            currentPatient.sex = document.getElementById('sex').value;
            currentPatient.cancer = document.getElementById('cancer').value;
            currentPatient.vitals.temperature = parseFloat(document.getElementById('temperature').value) || 37.0;
            currentPatient.vitals.bloodPressure = document.getElementById('bloodPressure').value || '120/80';
            currentPatient.vitals.heartRate = parseInt(document.getElementById('heartRate').value) || 75;
            
            const chronicSelect = document.getElementById('chronicDiseases');
            currentPatient.chronicDiseases = Array.from(chronicSelect.selectedOptions).map(opt => opt.value).filter(v => v !== 'none');
            
            updateSidebarVitals();
            savePatientData();
            
            if (currentPatient.sessions.length > 0) {
                runSimulation();
            }
        }

        function updateDoseDisplay() {
            const dose = currentPatient.cumulativeDose;
            const maxDose = 550;
            const percentage = Math.min(100, (dose / maxDose) * 100);
            
            document.getElementById('cumulativeDoseDisplay').textContent = `${dose} mg/m²`;
            document.getElementById('doseProgressBar').style.width = `${percentage}%`;
            
            const progressBar = document.getElementById('doseProgressBar');
            if (percentage < 60) {
                progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (percentage < 80) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }
        }

        async function addTreatmentSession() {
            if (!currentPatient) {
                alert('Please load or create a patient first!');
                return;
            }
            
            const sessionDose = 60;
            
            if (currentPatient.cumulativeDose + sessionDose > 600) {
                if (!confirm(`WARNING: High Dose Alert!\n\nCumulative dose will reach ${currentPatient.cumulativeDose + sessionDose} mg/m²\n\nThis EXCEEDS 550 mg/m² maximum.\n\nContinue?`)) {
                    return;
                }
            }
            
            currentPatient.cumulativeDose += sessionDose;
            
            const risks = calculateDigitalTwinRisks(currentPatient);
            const ragInsights = queryRAG(currentPatient);
            
            const session = {
                date: new Date().toISOString(),
                sessionNumber: currentPatient.sessions.length + 1,
                dose: sessionDose,
                cumulativeDose: currentPatient.cumulativeDose,
                vitals: { ...currentPatient.vitals },
                risks: risks,
                ragInsights: ragInsights
            };
            
            currentPatient.sessions.push(session);
            
            await savePatientData();
            
            await sendEmailNotification({
                patientId: currentPatient.id,
                timestamp: session.date,
                age: currentPatient.age,
                sex: currentPatient.sex,
                cancer: currentPatient.cancer,
                chronicDiseases: currentPatient.chronicDiseases,
                vitals: currentPatient.vitals,
                sessions: currentPatient.sessions,
                cumulativeDose: currentPatient.cumulativeDose,
                latestRisks: risks
            });
            
            updateDoseDisplay();
            document.getElementById('sessionCount').textContent = currentPatient.sessions.length;
            
            runSimulation();
            
            alert(`Session ${session.sessionNumber} Completed!\n\nDose: ${sessionDose} mg/m²\nCumulative: ${currentPatient.cumulativeDose} mg/m²\n\nCardio Risk: ${risks.cardioRisk}%\nNeutro Risk: ${risks.neutroRisk}%\nRecovery: ${risks.overallScore}`);
        }

        function runSimulation() {
            if (!currentPatient || currentPatient.sessions.length === 0) return;
            
            const latestSession = currentPatient.sessions[currentPatient.sessions.length - 1];
            const risks = latestSession.risks;
            const ragInsights = latestSession.ragInsights;
            
            document.getElementById('cardioRisk').textContent = risks.cardioRisk + '%';
            document.getElementById('neutroRisk').textContent = risks.neutroRisk + '%';
            document.getElementById('anemiaRisk').textContent = risks.anemiaRisk + '%';
            document.getElementById('qualityScore').textContent = risks.overallScore;
            
            displayDigitalTwinAnalysis(risks);
            displayAlerts(risks, ragInsights);
            displayRAGInsights(ragInsights);
            displaySessionHistory();
            updateCharts();
            updatePatientView(risks);
        }

        function displayDigitalTwinAnalysis(risks) {
            const container = document.getElementById('digitalTwinAnalysis');
            
            let html = '<div class="twin-analysis-box">';
            html += '<h4> Digital Twin Personalized Analysis</h4>';
            html += `<p><strong>${currentPatient.id}</strong> | ${currentPatient.age}yo ${currentPatient.sex} | ${currentPatient.cancer} | ${currentPatient.cumulativeDose} mg/m²</p>`;
            
            if (risks.cardioModifiers && risks.cardioModifiers.length > 0) {
                html += '<p><strong>Cardiotoxicity Factors:</strong></p><ul>';
                risks.cardioModifiers.forEach(mod => html += `<li>${mod}</li>`);
                html += '</ul>';
            }
            
            if (risks.neutroModifiers && risks.neutroModifiers.length > 0) {
                html += '<p><strong>Neutropenia Factors:</strong></p><ul>';
                risks.neutroModifiers.forEach(mod => html += `<li>${mod}</li>`);
                html += '</ul>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayAlerts(risks, ragInsights) {
            const alertsContainer = document.getElementById('clinicalAlerts');
            alertsContainer.innerHTML = '';
            
            if (risks.cardioRisk > 20) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>⚠️ HIGH CARDIOTOXICITY RISK</h4>
                    <p><strong>Risk: ${risks.cardioRisk}%</strong></p>
                    <p><strong>Actions Required:</strong></p>
                    <ul>
                        <li>Consider dexrazoxane cardioprotection</li>
                        <li>Schedule echocardiogram within 1 week</li>
                        <li>Monitor troponin I levels</li>
                        <li>Evaluate ACE inhibitor prophylaxis</li>
                    </ul>
                `;
                alertsContainer.appendChild(alert);
            }
            
            if (risks.neutroRisk > 60) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <h4>⚠️ HIGH NEUTROPENIA RISK</h4>
                    <p><strong>Risk: ${risks.neutroRisk}%</strong></p>
                    <p><strong>Actions Required:</strong></p>
                    <ul>
                        <li>Prophylactic G-CSF recommended</li>
                        <li>Monitor CBC on days 7, 10, 14</li>
                        <li>Consider prophylactic antibiotics</li>
                        <li>Patient fever protocol education</li>
                    </ul>
                `;
                alertsContainer.appendChild(alert);
            }
        }

        function displayRAGInsights(ragInsights) {
            const container = document.getElementById('ragStudiesContainer');
            container.innerHTML = '';
            
            if (!ragInsights || !ragInsights.studies || ragInsights.studies.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">No high-risk factors identified. Patient within safe parameters.</p>';
                return;
            }
            
            ragInsights.studies.forEach(study => {
                const card = document.createElement('div');
                card.className = 'study-card';
                card.innerHTML = `
                    <h5>${study.title}</h5>
                    <span class="relevance-tag">${study.category}</span>
                    <p style="margin-top: 12px;"><strong>Findings:</strong> ${study.findings}</p>
                    <p style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <strong>Relevance:</strong> ${study.patientRelevance}
                    </p>
                    <cite>${study.citation}</cite>
                `;
                container.appendChild(card);
            });
        }

        function displaySessionHistory() {
            const container = document.getElementById('sessionHistoryList');
            container.innerHTML = '';
            
            currentPatient.sessions.forEach((session) => {
                const item = document.createElement('div');
                item.className = 'session-item';
                const date = new Date(session.date).toLocaleDateString();
                const time = new Date(session.date).toLocaleTimeString();
                item.innerHTML = `
                    <h4>Session ${session.sessionNumber} - ${date} at ${time}</h4>
                    <p><strong>Dose:</strong> ${session.dose} mg/m² | <strong>Cumulative:</strong> ${session.cumulativeDose} mg/m²</p>
                    <p><strong>Vitals:</strong> BP: ${session.vitals.bloodPressure} | HR: ${session.vitals.heartRate} bpm | Temp: ${session.vitals.temperature}°C</p>
                    <p><strong>Risks:</strong> Cardio: ${session.risks.cardioRisk}% | Neutro: ${session.risks.neutroRisk}% | Recovery: ${session.risks.overallScore}</p>
                `;
                container.appendChild(item);
            });
        }

        function updateCharts() {
            updateRiskChart();
            updateProgressChart();
            updatePatientJourneyChart();
        }

        function updateRiskChart() {
            const ctx = document.getElementById('riskChart');
            if (!ctx) return;
            
            const latestSession = currentPatient.sessions[currentPatient.sessions.length - 1];
            const risks = latestSession.risks;
            
            if (charts.riskChart) charts.riskChart.destroy();
            
            const colors = [
                risks.cardioRisk > 30 ? '#dc2626' : risks.cardioRisk > 15 ? '#f59e0b' : '#10b981',
                risks.neutroRisk > 70 ? '#dc2626' : risks.neutroRisk > 50 ? '#f59e0b' : '#3b82f6',
                risks.anemiaRisk > 60 ? '#dc2626' : risks.anemiaRisk > 40 ? '#f59e0b' : '#8b5cf6',
                risks.nauseaRisk > 85 ? '#dc2626' : risks.nauseaRisk > 70 ? '#f59e0b' : '#10b981',
                risks.fatigueRisk > 70 ? '#dc2626' : risks.fatigueRisk > 50 ? '#f59e0b' : '#ec4899'
            ];
            
            charts.riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cardiotoxicity', 'Neutropenia', 'Anemia', 'Nausea', 'Fatigue'],
                    datasets: [{
                        label: 'Risk (%)',
                        data: [risks.cardioRisk, risks.neutroRisk, risks.anemiaRisk, risks.nauseaRisk, risks.fatigueRisk],
                        backgroundColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateProgressChart() {
            const ctx = document.getElementById('progressChart');
            if (!ctx) return;
            
            const progressData = currentPatient.sessions.map((session, idx) => ({
                session: `S${idx + 1}`,
                cardio: session.risks.cardioRisk,
                neutro: session.risks.neutroRisk,
                score: session.risks.overallScore,
                dose: session.cumulativeDose
            }));
            
            if (charts.progressChart) charts.progressChart.destroy();
            
            charts.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: progressData.map(d => d.session),
                    datasets: [
                        {
                            label: 'Recovery Score',
                            data: progressData.map(d => d.score),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cardiotoxicity',
                            data: progressData.map(d => d.cardio),
                            borderColor: '#ef4444',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Neutropenia',
                            data: progressData.map(d => d.neutro),
                            borderColor: '#3b82f6',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cumulative Dose',
                            data: progressData.map(d => d.dose),
                            borderColor: '#8b5cf6',
                            borderDash: [5, 5],
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', max: 100 },
                        y1: { position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function updatePatientJourneyChart() {
            const ctx = document.getElementById('patientJourneyChart');
            if (!ctx) return;
            
            const journeyData = currentPatient.sessions.map((session, idx) => ({
                session: `S${idx + 1}`,
                overall: session.risks.overallScore
            }));
            
            if (charts.patientJourneyChart) charts.patientJourneyChart.destroy();
            
            charts.patientJourneyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: journeyData.map(d => d.session),
                    datasets: [{
                        label: 'Health Score',
                        data: journeyData.map(d => d.overall),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function updatePatientView(risks) {
            const noData = document.getElementById('noDataMessage');
            const dataContent = document.getElementById('patientDataContent');
            
            if (currentPatient.sessions.length === 0) {
                noData.style.display = 'block';
                dataContent.style.display = 'none';
                return;
            }
            
            noData.style.display = 'none';
            dataContent.style.display = 'block';
            
            updateRecoveryCircle(risks.overallScore);
            
            const heartScore = 100 - risks.cardioRisk;
            document.getElementById('patientHeartScore').textContent = Math.round(heartScore);
            document.getElementById('heartBar').style.width = heartScore + '%';
            
            const bloodScore = 100 - risks.neutroRisk;
            document.getElementById('patientBloodScore').textContent = Math.round(bloodScore);
            document.getElementById('bloodBar').style.width = bloodScore + '%';
            
            const energyScore = 100 - risks.fatigueRisk;
            document.getElementById('patientEnergyScore').textContent = Math.round(energyScore);
            document.getElementById('energyBar').style.width = energyScore + '%';
            
            updatePatientAdvice(risks);
        }

        function updateRecoveryCircle(score) {
            const svg = document.getElementById('recoveryCircleSVG');
            const numberDisplay = document.getElementById('recoveryScoreNumber');
            const messageDisplay = document.getElementById('recoveryMessage');
            
            const radius = 85;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score / 100) * circumference;
            
            let color = score > 70 ? '#10b981' : score > 40 ? '#f59e0b' : '#ef4444';
            
            svg.innerHTML = `
                <circle cx="100" cy="100" r="85" fill="none" stroke="#e5e7eb" stroke-width="12"/>
                <circle cx="100" cy="100" r="85" fill="none" stroke="${color}" stroke-width="12"
                        stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                        transform="rotate(-90 100 100)" stroke-linecap="round"/>
            `;
            
            numberDisplay.textContent = score;
            
            if (score > 70) {
                messageDisplay.innerHTML = '✅ <strong>Great Recovery!</strong> Your body is handling treatment well.';
            } else if (score > 40) {
                messageDisplay.innerHTML = '⚠️ <strong>Moderate Strain.</strong> Rest and follow your care plan.';
            } else {
                messageDisplay.innerHTML = '🚨 <strong>High Strain.</strong> Contact your healthcare team today.';
            }
        }

        function updatePatientAdvice(risks) {
            const adviceSection = document.getElementById('patientAdviceSection');
            
            let html = '<h3 style="color: #0066cc;"> Your Personalized Care Guide</h3>';
            html += '<p style="color: #666; margin-bottom: 20px;">Based on your current treatment</p>';
            
            const systolic = parseInt(currentPatient.vitals.bloodPressure.split('/')[0]);
            
            if (systolic > 140 || currentPatient.vitals.heartRate > 100) {
                html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">';
                html += '<h4 style="color: #856404; margin-bottom: 10px;"> Health Status Alert</h4>';
                if (systolic > 140) {
                    html += `<p>Blood pressure (${currentPatient.vitals.bloodPressure}) is elevated. Reduce salt and contact your doctor.</p>`;
                }
                html += '</div>';
            }
            
            if (risks.cardioRisk > 20) {
                html += '<div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ef4444;">';
                html += '<h4 style="color: #991b1b; margin-bottom: 10px;"> Heart Care</h4>';
                html += `<p>Heart risk: ${risks.cardioRisk}%</p>`;
                html += '<ul style="margin-left: 20px; color: #7f1d1d;">';
                html += '<li>Eat heart-healthy foods</li>';
                html += '<li>Gentle 10-minute walks</li>';
                html += '<li>Avoid smoking and alcohol</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            if (risks.neutroRisk > 60) {
                html += '<div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">';
                html += '<h4 style="color: #1e40af; margin-bottom: 10px;"> Infection Prevention</h4>';
                html += `<p>Infection risk: ${risks.neutroRisk}%</p>`;
                html += '<ul style="margin-left: 20px; color: #1e3a8a;">';
                html += '<li>Wash hands frequently</li>';
                html += '<li>Avoid crowds</li>';
                html += '<li>Cook food thoroughly</li>';
                html += '<li>Call doctor if fever ≥38°C</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            html += '<div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">';
            html += '<h4 style="color: #991b1b; margin-bottom: 10px;"> Call Doctor If:</h4>';
            html += '<ul style="margin-left: 20px; color: #7f1d1d; font-weight: 500;">';
            html += '<li>Fever ≥38°C (100.4°F)</li>';
            html += '<li>Chest pain or breathing difficulty</li>';
            html += '<li>Unusual bleeding</li>';
            html += '<li>Severe dizziness</li>';
            html += '</ul>';
            html += '</div>';
            
            adviceSection.innerHTML = html;
        }

        function switchView(mode) {
            currentView = mode;
            
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const doctorView = document.getElementById('doctorView');
            const patientView = document.getElementById('patientView');
            
            if (mode === 'patient') {
                doctorView.style.display = 'none';
                patientView.style.display = 'block';
                if (currentPatient && currentPatient.sessions.length > 0) {
                    const latestRisks = currentPatient.sessions[currentPatient.sessions.length - 1].risks;
                    updatePatientView(latestRisks);
                }
            } else {
                doctorView.style.display = 'block';
                patientView.style.display = 'none';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function exportPatientReport() {
            if (!currentPatient) return;
            
            let report = `CHEMOTHERAPY DIGITAL TWIN REPORT\n${'='.repeat(60)}\n\n`;
            report += `Patient: ${currentPatient.id}\n`;
            report += `Date: ${new Date().toLocaleString()}\n\n`;
            report += `Age: ${currentPatient.age} | Sex: ${currentPatient.sex} | Cancer: ${currentPatient.cancer}\n`;
            report += `Chronic Diseases: ${currentPatient.chronicDiseases.join(', ') || 'None'}\n\n`;
            report += `Cumulative Dose: ${currentPatient.cumulativeDose} mg/m²\n`;
            report += `Total Sessions: ${currentPatient.sessions.length}\n\n`;
            
            if (currentPatient.sessions.length > 0) {
                const latest = currentPatient.sessions[currentPatient.sessions.length - 1];
                report += `LATEST RISK ASSESSMENT:\n`;
                report += `Cardiotoxicity: ${latest.risks.cardioRisk}%\n`;
                report += `Neutropenia: ${latest.risks.neutroRisk}%\n`;
                report += `Anemia: ${latest.risks.anemiaRisk}%\n`;
                report += `Recovery Score: ${latest.risks.overallScore}\n\n`;
                
                report += `SESSION HISTORY:\n`;
                currentPatient.sessions.forEach(s => {
                    report += `\nSession ${s.sessionNumber} - ${new Date(s.date).toLocaleString()}\n`;
                    report += `  Dose: ${s.dose} mg/m² | Cumulative: ${s.cumulativeDose} mg/m²\n`;
                    report += `  Vitals: BP ${s.vitals.bloodPressure} | HR ${s.vitals.heartRate} | Temp ${s.vitals.temperature}°C\n`;
                    report += `  Risks: Cardio ${s.risks.cardioRisk}% | Neutro ${s.risks.neutroRisk}% | Recovery ${s.risks.overallScore}\n`;
                });
            }
            
            report += `\n${'='.repeat(60)}\n`;
            report += `ChemoTwin Clinical Platform - Evidence-Based Digital Twins\n`;
            report += `Developed by Bakr Waheed\n`;
            report += `Contact: bakrwaheed0@gmail.com\n`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ChemoTwin_${currentPatient.id}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Bluetooth connection functions
        async function connectBluetoothDevice() {
            const connectBtn = document.getElementById('connectBtn');
            
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                return;
            }
            
            try {
                connectBtn.textContent = 'Searching...';
                
                // Request any Bluetooth device to improve scanning
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['heart_rate', 'battery_service', 'device_information', 'generic_access']
                });
                
                connectBtn.textContent = 'Connecting...';
                
                const server = await bluetoothDevice.gatt.connect();
                
                // Try to get heart rate service if available
                try {
                    const service = await server.getPrimaryService('heart_rate');
                    heartRateCharacteristic = await service.getCharacteristic('heart_rate_measurement');
                    
                    await heartRateCharacteristic.startNotifications();
                    heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChange);
                } catch (hrError) {
                    console.log('Heart rate service not available, using simulated data');
                    // Simulate heart rate data if service not available
                    startSimulatedVitals();
                }
                
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                document.getElementById('deviceStatusDot').classList.add('connected');
                document.getElementById('deviceStatusText').textContent = `Connected: ${bluetoothDevice.name || 'Device'}`;
                document.getElementById('vitalsDisplay').style.display = 'block';
                connectBtn.textContent = 'Disconnect';
                connectBtn.classList.add('btn-disconnect');
                
            } catch (error) {
                console.error('Bluetooth connection error:', error);
                if (error.name === 'NotFoundError') {
                    alert('No Bluetooth device selected. Please try again and select a device from the list.');
                } else {
                    alert('Failed to connect to device: ' + error.message);
                }
                connectBtn.textContent = 'Connect Device';
            }
        }
        
        // Simulate vitals if real device doesn't support heart rate service
        let simulatedInterval = null;
        function startSimulatedVitals() {
            if (simulatedInterval) clearInterval(simulatedInterval);
            
            simulatedInterval = setInterval(() => {
                if (currentPatient && bluetoothDevice && bluetoothDevice.gatt.connected) {
                    // Simulate realistic heart rate variations
                    const baseHR = parseInt(currentPatient.vitals.heartRate) || 75;
                    const variation = Math.floor(Math.random() * 10) - 5;
                    const newHR = Math.max(60, Math.min(100, baseHR + variation));
                    
                    currentPatient.vitals.heartRate = newHR;
                    document.getElementById('heartRate').value = newHR;
                    updateSidebarVitals();
                    
                    // Simulate slight BP variations
                    const bpParts = currentPatient.vitals.bloodPressure.split('/');
                    const systolic = parseInt(bpParts[0]) + (Math.random() > 0.5 ? 1 : -1);
                    const diastolic = parseInt(bpParts[1]) + (Math.random() > 0.5 ? 1 : -1);
                    currentPatient.vitals.bloodPressure = `${systolic}/${diastolic}`;
                    document.getElementById('bloodPressure').value = currentPatient.vitals.bloodPressure;
                    
                    savePatientData();
                    
                    if (currentPatient.sessions.length > 0) {
                        runSimulation();
                    }
                }
            }, 2000);
        }

        function handleHeartRateChange(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            
            if (currentPatient) {
                currentPatient.vitals.heartRate = heartRate;
                document.getElementById('heartRate').value = heartRate;
                updateSidebarVitals();
                savePatientData();
                
                if (currentPatient.sessions.length > 0) {
                    runSimulation();
                }
            }
        }

        function onDisconnected() {
            document.getElementById('deviceStatusDot').classList.remove('connected');
            document.getElementById('deviceStatusText').textContent = 'Device Disconnected';
            document.getElementById('vitalsDisplay').style.display = 'none';
            document.getElementById('connectBtn').textContent = 'Connect Device';
            document.getElementById('connectBtn').classList.remove('btn-disconnect');
        }

        // Particle animation
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
                particle.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(particle);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            createParticles();
            trackVisitor();
        });
    </script>
</body>
</html>
